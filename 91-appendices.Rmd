`r if(knitr:::is_latex_output()) '\\appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 
<!-- this first appendix line 1 starts the appendix secioning and should be called prior to the references -->
# Appendix A bbsAssistant: an R package for Download and Munging Data and Information from the North American Breeding Bird Survey {-#bbsAssistant}
*[Under review at the Journal for Open Source Software](https://github.com/openjournals/joss-papers/tree/joss.01550/joss.01550). JLB is the creator and maintainer of the package. G. Palomo-Mu\~{n}oz and Lyndsie Wszola are co-authors. tentative doi: 10.21105.joss.01550*

## Package Summary

This package contains functions for downloading and munging data from the North American Breeding Bird Survey (BBS) FTP server [@pardieck2018north; @sauer2017first]. Although the FTP server provides a public interface for retrieving data and analysis results, this package consolidates the efforts of the data user by automating downloading and decompression of .zip data files, downloading route-level information, and saving them as .feather files for speedy import from disk. The data subsetting features of this package also allow the user to readily import and save to file only the data necessary for her purposes. Although the primary audience is for those wishing to use BBS data in Program R for visualization or analysis, this package can be used to quickly download the BBS data to file for use elsewhere. 

The BBS team uses hierarhical modelling techniques to generate population trend estimates [@sauer2017results] at various spatial scales [see the BBS results webpage](https://www.mbr-pwrc.usgs.gov/). Given the variability in data availability, the BBS team also provides data credibility scores for species-regions combinations. This package contains two functions for retrieving the population trend estimates produced by @sauer2017results and the associated data credibility scores: a web-scraping function for obtaining current region and/or species-specific population trend estimates and data credibility scores via a supplied url, [`get_credibility_trends()`](https://github.com/TrashBirdEcology/bbsAssistant/blob/master/R/get_credibility_trends.R); and a function for the current and archived population trends estimates for *all* species and regions, [`get_analysis_results()`](https://github.com/TrashBirdEcology/bbsAssistant/blob/master/R/get_analysis_results.R). 

## Package Vignette
```{r}
knitr::opts_chunk$set(eval=FALSE)
```

### Installing package and loading dependencies
```{r loadDeps, echo=TRUE, warning=FALSE, message=FALSE}
# devtools::install_github("trashbirdecology/bbsAssistant", dependencies = TRUE, force=FALSE)
library(bbsAssistant)
library(rvest)
library(gdata)
library(feather)
library(here)
library(dplyr)
library(tidyverse)
```
### Downloading the BBS data from USGS FTP
This section reviews functionality for downloading and writing to file the BBS data from the FTP server.

#### Define and/or create local directories
This function will create, if it does not already exist, folder **./bbsData/** within which to locally store BBS data and results.
**NOTE**: If the directory exists, it will not overwrite files. If the bbs data already exists inside bbsDir, then we will create a logical to NOT download the data (see below). If you wish to download more, or overwrite existing data, please specify downloadBBSData=TRUE or remove .zip files from **/bbsData/**.
```{r  bbsass.makedirs, echo=TRUE, eval=FALSE}
# Create a directory to store and/or load the BBS data as feathers
bbsDir <- here::here("bbsData/")
dir.create(bbsDir)
```

#### Retrieve and import BBS data

If necessary, download all or some of the BBS state-level data. Note: Downloading all the data to file takes 10-15 minutes, so only run if you have not recently downloaded the BBS data.  First, let's retrieve the regions of data that are available. The function `get_regions` retrieves the .zip filenames of all U.S. states and Canadian provinces, including their reference numbers and region codes.
```{r, echo=TRUE, waring=FALSE, message=FALSE, eval=FALSE}
# a. Load the regional .txt file from Patuxent's FTP server (you must be connected to the internet to perform this step)
regions <- get_regions()
```

Let's restrict our data download to **Florida** data:
```{r, echo=TRUE, eval=FALSE}
regionFileName.use <- "Florida.zip"

if(!exists("regionFileName.use")){
  regionFileName <- regions$zipFileName %>% na.omit()
  (regionFileName.use <- regionFileName[which(str_detect(regionFileName, "Flori")==TRUE)])
}
```

Once we have one or more region filenames, we can use function `get_bbsData` to download the .zip file to a temporary folder (unless otherwise specified), and *import* the temp file to R object. The R object, flBBS, contains the raw BBS count data.
```{r, echo=TRUE, eval=FALSE}
flBBS <- get_bbsData(file=regionFileName.use)
```

Next, we can download the BBS route-level geographic information and metadata, and append this to the original data.
```{r, echo=TRUE, eval=FALSE}
routes <- get_routeInfo() # retrieve route-level data
flBBS <- left_join(flBBS, routes) # merge route-level data to bird count data
glimpse(flBBS %>% dplyr::select(aou, year, route, statenum, countrynum, stoptotal, latitude, longitude))
```

If we wish to save these data to file, we can do so by saving as **.feather*s, a compressed file formatted for use in R.
```{r, echo=TRUE, eval=FALSE}
export_bbsFeathers(dataIn = flBBS,
                newDir  = bbsDir,
                filename = regionFileName.use)
```


### Import BBS data from file into R

If the BBS data was downloaded previously and saved as .feather, we can import it using `import_bbsFeathers`. The code below is particularly useful if you are importing multiple files (e.g., multiple states)
```{r import_bbsFeathers, echo=TRUE, eval=FALSE}

(featherNames <- list.files(bbsDir, pattern = ".feather"))
featherNames <- str_c("/", featherNames) #add separator

feather <- import_bbsFeathers(newDir  = bbsDir,
                              filename = featherNames)
glimpse(feather) # Notice that the data imported from disk (feathers) differs from the original BBS data in that the # of columns is fewer (9 and 12 columns, respectively).
```

#### Option for downloading ALL BBS data
If you wish to download and/or import ALL the data, you might choose to do so in a loop. Note: this is expensive! The following are not run in this example.
```{r downloadAllBBS, eval = FALSE, echo=TRUE, eval=FALSE}
# Throw a warning if files exist
    if(length(list.files(bbsDir, pattern = "*.feather")) > 0 ){
        downloadBBSData = FALSE
    }else(
        {dir.create(bbsDir)
        downloadBBSData = TRUE}
        )
## Download ALL the regions of BBS data
if(downloadBBSData==TRUE){
for(i in 1:length(regionFileName)){
        bbsData <-  import_bbsData(
            # arguments for get_bbsData()
            file = regionFileName[i],
            dir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/States/",
            year = NULL, # subset by year
            aou = NULL, # subset by AOU #s
            countrynum = NULL, # subset by country number
            states = NULL, # subset by state/povince number
            #  arguments for get_routeInfo():
            routesFile = "routes.zip",
            routesDir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/",
            RouteTypeID = 1,
            # one or more of c(1,2,3)
            Stratum = NULL,  # subset by BBS stratum
            BCR = NULL # subset by BCR (bird conservation region)
        )
# d. Save the unzipped files to disk.
export_bbsFeathers(dataIn  = bbsData,
                newDir  = bbsDir,
                filename = regionFileName[i])
# e. Clear object from memory
rm(bbsData)
} # end section I. loop
}else(message(paste0("NOT DOWNLOADING BBS DATA. If you wish to download the BBS data, please remove files from directory: ",bbsDir))) # end if-else to download the data
```

Use the same code as above to import *multiple* feathers from file:
```{r loadAllData, eval = FALSE, echo=TRUE, eval=FALSE}
feathers <- NULL
featherNames <- list.files(bbsDir, pattern = ".feather")
featherNames <- str_c("/", featherNames) #add separator
for (i in 1:length(featherNames)) {
  feather <- NULL
  feather <- import_bbsFeathers(newDir  = bbsDir,
                              filename = featherNames[i])
  feathers <- rbind(feathers, feather)
  rm(feather)

}
```

### Subsetting the BBS count data
#### Subset BBS data by taxonomic groups
First, retrieve the species list from the BBS FTP server.
```{r getSpList, echo=TRUE, eval=FALSE}
spp <- get_speciesList()
glimpse(spp)
```

Subset by species AOU # (e.g. House Sparrow aou = 06882)
```{r subset_bySpeciesList, echo=TRUE, eval=FALSE}
subset_speciesList(myData = flBBS, aou.ind = 06882) %>% glimpse()
```

We could merge the bbs count data with the species list to avoid having to refer to AOU, then just subset using species name (e.g. 'House Sparrow).
```{r getHospData, echo=TRUE, eval=FALSE}
flBBS <- left_join(flBBS, spp)
hospBBS <- flBBS %>% filter(commonName=="House Sparrow")
```

We can also  use the `subset_SpeciesList` as a convenient way to **remove**  taxonomic groups from the BBS data.
```{r , echo=TRUE, eval=FALSE}
flBBS.subset <- subset_speciesList(flBBS, fam.ind = "Passeridae")
flBBS.subset <- subset_speciesList(flBBS, fam.ind = c("Passeridae", "Parulidae")) # or remove multiple fams
```

### Retrieve BBS analysis results and data credibility measures
There are a few options for obtaining species trends estimates and credibility measures: 1) download the entire region-species csvs for various analyses or 2) provide a URl to species- or region-specific estimates for the 1966-2015 trend estimates.

#### Option 1: Download CSV for all species-region combinations
The function `get_analysis_results` allows you to specify an analysis type, and upload all species-regions combination estimates or annual indices to object.
Let's look at Florida House Sparrow trend estimates for Florida:
```{r get_analysis_results, echo=TRUE, eval=FALSE}
results <- get_analysis_results(analysis = "trend.ests") # default here is to obtain the 1966-2015 species trend estimates
results.flHOSP <- results %>% filter(Species.Name=="House Sparrow", Region.Code=="FLA")
```

Get annual trend estimates for Florida 1966-2016 analysis:
```{r get_analysis_results2, echo=TRUE, eval=FALSE}
results <- get_analysis_results(analysis = "annual.inds.2016") # default here is to obtain the 1966-2015 species trend estimates
```

```{r , echo=TRUE, eval=FALSE, out.width="33%"}
library(ggplot2)
ggplot(data = results %>% filter(AOU.Number=='s06882',
                   Region.Code=="S05"),
       aes(Year, Annual.Index))+
    geom_point() +
    labs(y="HOSP annual population \ntrend index in region S05")+
    theme_bw()
```

#### Options 2: Retrieve region-specific estimates using web-scraping
Another useful feature of this package is the ability to retrieve data credibility and species trend estimates from the BBS results using the function `get_credibility_trends`. This function allows the user to input a url to the region- or species-specific results page (see instructions below), as opposed to using function `get_analysis_results`. As an example, we  retrieve the credibility scores and species trend estimates for **House Sparrows in Florida**.
```{r getCredTrends, echo=TRUE, eval=FALSE}
cred <- get_credibility_trends() # default here is Florida House Sparrows.

# credibility colors correspond with the color scheme used on the BBS results page
cred %>% distinct(credibilityNumber, credibilityColor, credibilityClass)
```

Trend estimates are also listed in `cred` for Florida House Sparrow data:
```{r , echo=TRUE, eval=FALSE}
cred %>%
    filter(Species == "House Sparrow") %>%
    glimpse()
```

#### Steps for obtaining argument "url" in function `get_credibility_trends`:
First, visit the USGS Patuxent Wildlife Research Center's [website for BBS results](https://www.mbr-pwrc.usgs.gov/) Online <https://www.mbr-pwrc.usgs.gov/>. Next, enable the drop-down **Survey Results**, and choose **Trend Estimates (by region)** (left) and choose the desired region (e.g. Florida):
![](./chapterFiles/appendices/regcred_select_trendests_byregion.png){width=300px}![](./chapterFiles/appendices/regcred_select_fl.png)
Finally, copy the URL address for the page including the results and credibility measures (e.g. Florida):
![](./chapterFiles/appendices/regcred_fl_ex.png)

## Package Manual  
For functions and descriptions please see the [manual](github.com/bbsAssistant//bbsAssistant_0.0.0.9000.pdf). 

## Acknowledgements

We thank the participatory scientists who collect data annually for the North American Breeding Bird Survey, and the Patuxent Wildlife Research Center for making these data publicly and easily accessible. Some functions in this package were adapted from the [rBBS](github.com/oharar/rbbs) package and are mentioned in function source code as appicable.

`r if(knitr:::is_latex_output()) '\\appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 
# Appendix B regimeDetectionMeasures: an R package for calculating various regime detection measures {-#regimeDetectionMeasures}  
This appendix contains example analysis associated with the R Package, `regimeDetectionMeasures`. Development source code for this package is available on GitHub as a compressed file at [https://github.com/TrashBirdEcology/regimeDetectionMeasures/archive/master.zip](https://github.com/TrashBirdEcology/regimeDetectionMeasures/archive/master.zip) or at [https://github.com/TrashBirdEcology/regimeDetectionMeasures](https://github.com/TrashBirdEcology/regimeDetectionMeasures).

## Example Analysis
### Measures/metrics calculated
This package will calculate a various regime detection metrics that have been used to 'detect ecological regime shifts'. A 'new' metric, **distance travelled** is also calculated (Burnett and others, *in prep*).

**Composite measures:**  
1. Distance travelled -see also package [`distanceTravelled`](https://github.com/TrashBirdEcology/distanceTravelled).  
1. Fisher Information 
1. Variance Index  

**Single-variable measures:**  
1. Skewness (mean and mode versions)  
1. Kurtosis  
1. Variance  
1. Mean  
1. Mode  
1. Coefficient of variation, CV  
1. Autocorrelation lag-1 (using `stats::acf`)  

### Calculate Metrics analysis
```{r, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE, out.width = "85%")

library(regimeDetectionMeasures)

# Munge original data -----------------------------------------------------
origData = munge_orig_dat(example = T)
```

### Plots
Plot the original time series as relative abundances. 
```{r , echo=TRUE, eval=FALSE}
# Plot the original time series abundances
plot_orig_data(data = origData,
               example = F,
               print = T)
```

Plot the time elapsed among observations.
```{r , echo=TRUE, eval=FALSE}
# Plot the distance between observations
plot_timeDiff(data = origData,
              example = F,
              print = T)
```

Plot species richness over time.
```{r richness, echo=TRUE, eval=FALSE}
# Plot species richness over time
plot_richness(data = origData,
              example = T,
              print = T)

```

Plot the distance travelled (*s*) and velocity of distance travelled (*v*)
```{r calcDist, echo=TRUE, eval=FALSE}
# Calculate distance travelled and derviatves of this ---------------------
distances <- calculate_distanceTravelled(origData, derivs = T)
```

Plot the moving-window metrics (FI, VI, and the univariate EWSs)
```{r calcMovingWIndowShit}
# Calculate FI, VI, and early warning signals --------------------------------------------------------
# Uses a moving window analysis to calculate FI and Vi within each window
results <-
    rdm_window_analysis(
        origData,
        winMove = 0.25,
        min.window.dat = 2,
        fi.equation = "7.12",
        to.calc = c('EWS', 'VI')
    )

# Reults will return all results in a single data frame.
head(results)
```


`r if(knitr:::is_latex_output()) '\\appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 
# Appendix C bbsRDM: an R package for applying `regimeDetectionMeasures` functionality to spatial data {-#bbsRDM}

This appendix contains a vignette associated with the R Package, `bbsRDM`. Development source code for this package is available on GitHub as a compressed file, [https://github.com/TrashBirdEcology/bbsRDM/archive/master.zip ](https://github.com/TrashBirdEcology/bbsRDM/archive/master.zip ) or at [https://github.com/TrashBirdEcology/rRDM](https://github.com/TrashBirdEcology/rRDM).

This vignette runs through the capabilites of the bbsRDM package, which relies on the package `trashbirdecology::regimeDetectionMeasures`. Although this package can be used to calculate and visualize BBS data using time series, the  example at hand runs presents an application to spatial transects.


## Example Analysis
### Load packages & create local directories

There are a lot of dependencies to load.

```{r}
## Re-install often as this package is under major development.
# devtools::install_github("trashbirdecology/regimedetectionmeasures", force = FALSE)
library(regimeDetectionMeasures)
library(sp)
library(raster)
library(feather)
library(bbsRDM)
library(here)
```

```{r  bbsrdm_createDirs, echo=TRUE, eval=FALSE}
# Create directories to locally store BBS data and results.
# a. Create a directory to store and/or load the BBS data as feathers
bbsDir <- "./chapterFiles/appendix_bbsRDM/bbs_raw_data"
    # If the bbs data already exists inside bbsDir, then we will create a logical to NOT download it (see below)
        if(length(list.files(bbsDir, pattern = "*.feather")) > 0 ){
            downloadBBSData = FALSE
        }else(
            {dir.create(bbsDir)
            downloadBBSData = TRUE}
            )

# If this returns a warning, proceed with caution as directory already exists, and results WILL be OVERRIDDEN.

# b. Create a directory to store and/or load the BBS data as feathers
resultsDir <- "./chapterFiles/appendix_bbsRDM/myResults"
dir.create(resultsDir)
# ditto

# c. Create directory for storing early warning signal results
resultsDirEWS <- "./chapterFiles/appendix_bbsRDM/myResults/ews"
dir.create(resultsDirEWS)

# d. Create directory for storing distance travelled results
resultsDirDIST <- "./chapterFiles/appendix_bbsRDM/myResults/distances"
dir.create(resultsDirDIST)
```

### Download the BBS data and save to file locally
If necessary, download all the state data. This takes 10-15 minutes, so only run if you have not recently downloaded the BBS data or are missing data. 
```{r bbsrdm_getBBSdata, echo=TRUE, eval=FALSE}
# a. Load the regional .txt file from Patuxent's FTP server (you must be connected to the internet to perform this step)
regions <- GetRegions()

# b. Create a series or one filenames for states, regions
regionFileName <- regions$zipFileName %>% na.omit()

# c.  Download and unzip the BBS data.
if(downloadBBSData==TRUE){
for(i in 1:length(regionFileName)){
        bbsData <-  importDataBBS(
            # arguments for getDataBBS()
            file = regionFileName[i],
            dir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/States/",
            year = NULL,
            aou = NULL,
            countrynum = NULL,
            states = NULL,
            #  arguments for getRouteInfo():
            routesFile = "routes.zip",
            routesDir =  "ftp://ftpext.usgs.gov/pub/er/md/laurel/BBS/DataFiles/",
            RouteTypeID = 1,
            # one or more of c(1,2,3)
            Stratum = NULL,
            BCR = NULL
        )


# d. Save the unzipped files to disk.
birdsToFeathers(dataIn  = bbsData,
                newDir  = bbsDir,
                filename = regionFileName[i])
# e. Clear object from memory
rm(bbsData)
} # end section I. loop
}else(print(paste0("NOT DOWNLOADING BBS DATA. If you wish to download the BBS data, please remove files from directory: ",bbsDir))) # end if-else to download the data
```

### Create a sampling grid
Next, build a sampling grid to force route information onto a regular gridded area. This allows us to compare the results across space-time.
```{r bbsrdm_samplingGrid, echo=TRUE, eval=FALSE}
# III: Build sampling grid --------------------------------------------------------
# Define the grid's cell size (lat, long; unit:degrees)
        ## 1 deg latitude ~= 69 miles
        ## 1 deg longitude ~= 55 miles
cs <-
    c(0.5, 0.5)  # default is cell size 0.5 deg lat x 0.5 deg long

# Create the grid
routes_gridList <- createSamplingGrid(cs = cs)

# Define the components of the sampling grid as individual objects
routes_grid <- routes_gridList$routes_grid
sp_grd <- routes_gridList$sp_grd
rm(cs)
```


See if the results are already saved to file. This will save us some computational time when knitting the document. Otherwise, will take about a minute to calculate, depending on the size of birdsData

```{r bbsrdm_import.ind, echo=TRUE, eval=FALSE}
tempResultsDir <- here::here("/tempFiles_bbsRDM/")
dir.create(tempResultsDir)
fns <- list.files(tempResultsDir)
import.ind = ifelse(length(fns)!=0 %in% fns, TRUE,FALSE)
import.feathers <- ifelse("feathers.RDS" %in% list.files(tempResultsDir), FALSE, TRUE)
```

Now we load in the BBS data from the feathers we created and align with the sampling grid. This requires a bit of memory, proceed with caution. If it's already saved in the tempResultsDir, then it will merely upload the data from file.
```{r bbsrdm_importfeathers,echo=TRUE, eval=FALSE}
if(import.feathers){
feathers <- NULL
featherNames <- list.files(bbsDir, pattern = ".feather")
featherNames <- str_c("/", featherNames) #add separator
for (i in 1:length(featherNames)) {
  feather <- NULL
  feather <- loadBirdFeathers(newDir  = bbsDir,
                              filename = featherNames[i])

  feather <- feather %>%
    dplyr::rename(lat = latitude,
                  long = longitude) %>%
    left_join(routes_grid, by = c("countrynum", "statenum", "route", "lat", "long"))

  feathers <- rbind(feathers, feather)
  rm(feather)
  if(i == length(featherNames)) saveRDS(feathers, paste0(tempResultsDir, "feathers.RDS"))
}}else(feathers <- readRDS(paste0(tempResultsDir, "feathers.RDS")))
```

### Subset the BBS data by species and/or functional traits (OPTIONAL but highly recommended)
Although subsetting the speices is optional, I recommend removing waterfowl, wading birds, and shorebirds from analyses, especially as the spatial extent of the analysis increases.

### Subset species according to AOU species codes (i.e. by family, genera, etc..)
For this example we will remove shorebirds, wading birds, and waterfowl (i.e., AOU species' codes 0000:2880). *See `R/subsetByAOU.R` source code or documentation for options (see: `subset.by`)
```{r bbsrdm_subsetAOU, echo=TRUE, eval=FALSE}
# Subset the species
feathers <- subsetByAOU(myData = feathers, subset.by= 'remove.shoreWaderFowl')
```

### Subset species by trait, body mass, taxonomically, etc...(optional)
```{r bbsrdm_subsetFxn, eval =FALSE, message = TRUE, warning = FALSE, echo=TRUE, eval=FALSE}
# Load the functional trait and mass data, and munge/merge
require(dplyr)
funMass <-
    funcMass(dataWD = paste0(getwd(), "/data"),
             fxn = T, # get functional trait data?
             mass = F) # get body mass data?

# Combine the functional trqits and/or body mass
bbsData <-
    mergeFunMassBBS(bbsData = feather, funMass = funMass)

rm(funMass)
```

### Calculate regime detection metrics across space or time
First, define the parameters required to calcualte the metrics.
```{r bbsrdm_defineParams, echo=TRUE, eval=FALSE}
# Which metrics do you want to calculate?
metrics.to.calc <- c("distances", "ews")

# If calculating "EWSs, you can calculate select metrics.
## Default = all early-warning signals, FI, and VI
to.calc = c("EWS", "FI", "VI")

# Choose spatial or temporal analysis
direction <-
    "South-North" # choose one of : 'South-North', 'East-West', or 'temporal'

# Choose the fill value for species present in the entire time series (or sampling transect) but not present on that year. Using "NA" assumes the species with missing data *was not and could not have been present*. Using zero assumes the species could have been present but was not.
fill = 0

# Minimum number of sites (if spatial) or years (if temporal)  required to be in the entire sample (trnasect or time series)
min.samp.sites = 8

# Minimum number of sites (if spatial) or years (if temporal) required to be within a single window
min.window.dat = 3

# Which Equation of Fisher Information to use (default = 7.12)
fi.equation = "7.12"

# By what % of the entire data should the window move?
winMove = 0.25

# Define some filtering and labeling parameters based on direction of spatial analysis (if applicable)

if (direction == "South-North") {
    dir.use =  unique(feathers$colID) %>% na.omit(colID) %>% sort()}
if (direction == "East-West") {
    dir.use = unique(feathers$rowID) %>% na.omit(rowID) %>% sort()}

```

Define the years we want to analyze. For this (spatial) example, we will analyze only every fifth year in the available data. 
```{r bbsrdm_yearSubset, echo=TRUE, message=FALSE}
# Get all possible years
years.use = unique(feathers$year)

# Keep only the years which are divisible by T
T = 10
years.use  <- years.use[which(years.use %% T == 0 & years.use > 1975)] %>% sort()
```

### Conduct analysis
This section will loop through `years.use` and `dir.use`, running each BBS route (temooral analysis) or spatial transect by year (spatial analysis) at a time. Results are saved in directories created earlier.

```{r bbsrdm_calcMetrics, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
# **Please note: depending on the # of years and spatial transects, this could take a while!**
if(import.ind==FALSE) for (j in 1:length(dir.use)) {
    # For east-west analysis
        if (direction == "East-West"){
            birdsData <- feathers %>%
                filter(rowID == dir.use[j]) %>%
                mutate(direction = direction,
                       dirID = dir.use[j])
    }
    # For south-north analysis
        if (direction == "South-North"){
            birdsData <- feathers %>%
            filter(colID == dir.use[j]) %>%
            mutate(direction = direction,
                   dirID = dir.use[j])
    }



    if (nrow(birdsData) < min.samp.sites) {
        next(print(paste0("Not enough data to analyze. Skipping j-loop ", dir.use[j])))
    }


    # VX.  Analyze the data ---------------------------------------------------

    for (i in 1:length(years.use)){
        # a. Subset the data according to year, colID, rowID, state, country, etc.x
        birdData <- birdsData %>%
            filter(year == years.use[i]) %>%
            dplyr::rename(variable = aou,
                          value = stoptotal)



        if (nrow(birdData) == 0){
            next
        }

        # b. Munge the data further
        birdData <- mungeSubsetData(birdData)


        # X.   Calculate the metrics ---------------------------------------------------
        ## This function analyzes the data and writes results to file (in subdirectory 'myResults') as .feather files.
# browser()
        calculateMetrics(dataIn = birdData, metrics.to.calc, direction = direction,  yearInd = years.use[i])

        print(paste0("End i-loop (years) ", i, " of ",  length(years.use)))

    } # end i-loop

    print(paste0("End j-loop (transects) ", j, " of ",  length(dir.use)))
} # end j-loop
```

### Import and munge the results to prepare for visualization
First, import and combine the results as generated in the previous section. This following chunk imports the EWS results and the distance results separately, combining each into their own data frames.
```{r bbsrdm_importCalcMetrics, echo=TRUE, eval=FALSE}
#  Import EWS results
if(!"results_ews.RDS" %in% fns){results_ews <-
    importResults(resultsDir = resultsDir, myPattern = 'ews',
                  subset.by = direction) %>%
    # assign the end of the window as the cellID
    mutate(cellID = cellID_max)
  saveRDS(results_ews, file = paste0(tempResultsDir, "results_ews.RDS"))}
## FYI: rows will likely be absent when metricTypes = c(FI, VI), because FI and VI are calculated across multiple variables (species), rather than calculated for individual variables.

#  Import distance results
if(!"results_dist.RDS" %in% fns){ results_dist <-
    importResults(resultsDir = resultsDir, myPattern = 'distances', subset.by = direction)

    saveRDS(results_dist, file = paste0(tempResultsDir, "results_dist.RDS"))}

if(import.ind){
  fn = list.files(tempResultsDir, "results_ews", full.names = T)
  results_ews <- readRDS(fn)
  fn = list.files(tempResultsDir, "results_dist", full.names = T)
  results_dist <- readRDS(fn)
  rm(fn)
}  
```

Next, get the results to align with our sampling grid for visualizing results across space.
```{r bbsrdm_importresults, echo=TRUE, eval=FALSE}
#  Get the spatial sampling grid coordinates
coords_grd <-
    cbind(routes_gridList$sp_grd@data,
          coordinates(routes_gridList$sp_grd)) %>%
    rename(lat = s2,
           long = s1,
           cellID  = id)

# Join coords_grd with results
# note: a full join will likely produce many cells with NO results data..
# but NO lat or long should == NA!
distResults <-
    full_join(coords_grd,
              results_dist) %>%
    na.omit(metricType)

ewsResults <-
    full_join(coords_grd,
              results_ews) %>%
    na.omit(metricType) %>%
    dplyr::select(-cellID_min,-cellID_max, -winStart  , -winStop)

# d. Set coordinate system and projection
coordinates(distResults) <-
    coordinates(ewsResults) <- c("long", "lat")
sp::proj4string(distResults) <-
    sp::proj4string(ewsResults) <-
    sp::CRS("+proj=longlat +datum=WGS84")

```

### Visualize results: one regime detection metric at a time
First, specify plotting parameters. We can visualize either the distance results (`distResults`) or the early-warning signal results (`ewsResults`). Define the results we want to visualize:
```{r bbsrdm_plotresults, echo=TRUE, eval=FALSE}
# Specify results to visualize
plotResults <- distResults

# Which metric do we want to visualize
metric.ind <- "s"

# Sort the years
year.ind <- unique(plotResults@data$year) %>% sort()

# Create a label for plotting, depending on direction
sortVar.lab <-
    ifelse(unique(plotResults@data$direction) == "South-North",
           "latitude",
           "longitude")
```

Plot the individual transects. **Note: please specify dirID.ind as desired spatial transect number, and dirInd as direction (E-W or N-S)**
```{r bbsrdm.plotind.tsect, echo=TRUE, eval=FALSE}
# Specify the transect # we want to see
dirID.ind <- 13

metric.ind <- "s"


pl1 <- sort.year.line(plotResults, metric.ind, year.ind, dirID.ind, dirInd,  scale = T, center = T)
# +
#     # place a v-line at the
     # geom_vline(aes(xintercept=-96.8), color = "grey", linetype = 2)
pl1 

```

<!-- ## Source Code Documentation -->
<!-- ```{r, echo=TRUE, eval=FALSE} -->
<!-- knitr::include_graphics(here::here("packageDocumentation/bbsRDM.pdf")) -->
<!-- ``` -->
`r if(knitr:::is_latex_output()) '\\appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 
# Appendix D Functions used to calculate discontinuities in avian body mass distributions. {-#appDiscont}
## About
This code was first published in @barichievy2018method and has been slightly modified and annotated for the purposes of this dissertation. This code was used to produce body mass discontinuities in Chapter \#ref(discontinuity)

## Neutral.Null function
Neutral.Null <- function(log10.data, resolution = 4000) {
  Dmax = max(log10.data, na.rm = FALSE)
  Dmin = min(log10.data, na.rm = FALSE)
  ds = (Dmax - Dmin) / resolution
  MaxK = (Dmax - Dmin) / 2
  MinK = ds * 2
  
  #define h's to analyze
  ks = seq(MinK, MaxK, by = 1 / resolution)
  
  # generate matrix
  bws = matrix(data = NA,
               nrow = length(ks),
               ncol = 1)
  
  for (i in c(1:length(ks))) {
    # Calculate KS density estimate
    KSdens <- density(log10.data, bw = ks[i], "gaussian", adjust = 1)
    
    # Test if the ksdensity is unimodal
    TF <- which(diff(sign(diff(KSdens$y))) == 2) + 1
    if (length(TF) == 0)
      bws[i] = 1
    else
      bws[i] = 0
  }
  # Define the neutral Null
  r = min(which(bws == 1))
  hnull = ks[r]
  return(hnull)
}

## Bootstrapping Function
DD <- function(log10.data, hnull, Sample.N = 1000) {
  NNull <- density(log10.data, bw = hnull, "gaussian", adjust = 1)
  N <- length(log10.data)
  
  # generate matrix
  null.samples <- matrix(data = 0,
                         ncol = Sample.N,
                         nrow = N)
  for (i in 1:Sample.N) {
    #sample the null model
    rand.N <- sample(NNull$x, N, replace = TRUE, prob = NNull$y)
    #calculate the gaps
    null.samples[, i] <- sort(rand.N, decreasing = FALSE)
    #put into the matrxi
  }
  
  # generate gaps
  gaps.log10.data <- diff(log10.data)
  gaps.null.samples <- diff(null.samples, decreasing = FALSE) # difference between random samples and 1st diff orig dat
  gap.percentile <- matrix(data = 0,
                           nrow = length(gaps.log10.data),
                           ncol = 1)
  for (i in 1:length(gaps.log10.data)) {
    # generate distribution of gaps per row (per gap rank)
    gap.percentile[i] <-
      ecdf(gaps.null.samples[i, ])(gaps.log10.data[i]) # returns the percentile at each observation
    
  }
  Bootstrap.gaps <- rbind(gap.percentile, 0)
  Bootstrap.gaps <- cbind(log10.data, Bootstrap.gaps)
  return(Bootstrap.gaps)
}

