# Velocity (*v*): using rate-of-change of  system  trajectory to identify abrupt changes {#velocity}
```{r setupChVelocity, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
# # Chunk defaults
set.seed(123)
# knitr::opts_chunk$set(
  # cache = TRUE, cache.path = "_cache/",cache.lazy = FALSE,  message = FALSE, warning=FALSE, eval=TRUE, echo=FALSE, error=FALSE
  # )
## load pkgs
library(gridExtra)
# library(magrittr)
library(tidyverse)

## source code for theme_Publications
source(here::here("chapterFiles/velocity/06-chap-velocity_helperFuns.R"))

# Source some helper funs
source("./chapterFiles/velocity/06-chap-velocity_helperFuns.R")

## Define a plotting function for plotting simulated and dist results
sPlot <- function(df, dist, div = 10){
  if("sortVar" %in% names(dist))dist <- dist %>% rename(t = sortVar)
  ggplot()+
  geom_line(data = df, aes(t, value, linetype=variable), color='black')+
  geom_line(data = dist, aes(x = t, y = s/div), color = "red", size =1)+
  scale_y_continuous(sec.axis = sec_axis(~.*div, name = "s"))+
    theme_bw()+
  theme(legend.position = "bottom")}

dsdtPlot <- function(df, dist, div = 10){
  if("sortVar" %in% names(dist))dist <- dist %>% rename(t = sortVar)
ggplot()+
  geom_line(data = df, aes(t, value, linetype=variable), color='black')+
  geom_line(data = dist, aes(x = t, y = dsdt/div), color = "red", size =1)+
  scale_y_continuous(sec.axis = sec_axis(~.*div, name = "v"))+ 
  theme_bw()+
  theme(legend.position = "bottom")}
```
## Introduction
<!--  "There is a statistical approach to infer whether or not alternative attractors are involved in a shift [42], based on the principle that all attractor shifts imply a phase in that the system is speeding up as it is diverging from a repeller (see Box 2). from @Schefferand carpetner 2003"  -->
When, how and why ecological systems exhibit abrupt changes is a hallmark of modern ecological research, and changes that are unexpected and undesirable can have undesirable downstream consequences on, e.g., ecosystem services, biodiversity, and human well-being. Quantitatively detecting and forecasting these changes, however, has yet to be accomplished for most ecological systems [Chapter \@ref(rdmReview); @ratajczak2018abrupt]. Moving from abrupt change methods requiring highly descriptive models and *a priori* assumptions of the state variable responses to drivers to methods requiring few, if any, *a priori* assumptions or knowledge is increasingly necessary for forecasting and managing complex ecosystems under an era of intensifying anthropogenic pressures.

```{r lorenz3D, eval=TRUE, echo=FALSE,  fig.cap="An example solution of the Lorenz ('butterfly') represented in 3-dimensional phase-space. Phase plots are typically used to visualize stable areas within a system's trajectory but reconstruction requires the difference models to be known and parameterized.", out.width="75%"}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/lorenz3D.png"))
```

A few broad classes of quantitative approaches exist for quantitatively identifying abrupt changes in complex ecosystems. First, one can use simple mathematical models to describe the system and statistically test for discontinuities in the observed variables [e.g., in coral reefs, @mumby2013evidence]. Although mathematical representations are ideal, very rarely are  ecological systems easily and well-described by them and often fail to meet the assumptions of the model. Second, we can track changes in the mean or variance of state variables to identify departures from the norm [e.g., early-warning indicators such as variance and variance index, @brock_variance_2006]. Much like the mathematical modelling approach, these early-warning indicators have shown to be useful in some simple driver-response systems [e.g., lake eutrophication @carpenter_leading_2008], but are unreliable in other empirical systems [e.g., @perretti2012regime;@dutta2018robustness;@dakos2012robustness]. The last type of approach is the model-free approach [@dakos2012methods; Chapter \@ref(rdmReview)]. This group of abrupt change indicators can incorporate multiple state variables, and ideally requires no *a priori* assumptions about the expected driver-response relationships, or even about the drivers at all. It is this class of abrupt change indicators to that this chapter contributes. 

```{r lorenz3Dts, eval=TRUE, echo=FALSE,    out.width="75%", fig.cap="An example solution of the Lorenz ('butterfly') represented in individual system components."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/lorenz3D_timeseries.png"))
```

### Tracking ecosystem trajectory through time to explore system dynamics
A classic example of state-switching by a system is demonstrated in the Lorenz ('butterfly') attractor [Figure \@ref(fig:lorenz3D); @takens1981detecting]. This phase plot (Figure \@ref(fig:lorenz3D)) provides an informative visual of the behavior of a chaotic system manifesting two attractors. Although the periodic, attractor behaviors are made clear when examining the time series of each dimension (Fig \@ref(fig:lorenz3Dts)), identifying such behaviors in additional dimensions becomes increasingly difficult. 

System trajectory in phase space are used often in dynamical systems theory and systems ecology to make inference regarding system behavior and dynamics, but phase space (trajectory) dynamics are not commonly applied outside theoretical studies as a tool for ecological data analysis [c.f. @sugihara2012detecting for an example of phase-space reconstruction using Taken's theorem applied to ecological time series]. Some methods of attractor reconstruction have been applied to environmental data [e.g., individual time series of fisheries stocks, climate, stock market; @sugihara2012detecting; @ye2015equation], yet they **do not incorporate the dynamics of whole-systems**. Model-free methods for exploring and describing the dynamics of whole ecological systems are largely restricted to the commonly-applied dimension reduction techniques and clustering algorithms (e.g., Principal Components Analysis, K-means clustering). In fact, this is true of many abrupt change and regime shift indicators. 

### Rate of change as an indicator of abrupt change in the system trajectory
How quickly a system switches states [e.g., moving from attractor to another; \@ref(fig:lorenz3D)] may yield insights into the responses of ecological systems to perturbations (e.g., anthropogenically induced pressures such as climate change, urbanization) and community shifts (e.g., species introductions or extinctions, shifts in dominance). For example, @beck_variance_2018 tracked rate of change using chord distances---a data transformation for positive values and that is suitable prior to ordination analysis---to capture abrupt changes in community composition of a temperate, paleodiatom community. Chord distance, however, is greatest when the observations among data rows (e.g., time, location) have no species in common. In other words, this measurement may be most useful in high community turnover conditions. Alternative numerical methods for estimating system rates of change may be useful when the system does not exhibit, for example, high degrees of turnover or changes other in simple, biodiversity metrics. 

Rate of change (ROC, often represented as $\Delta$) is a term used for various measures that describe the relationship among to variables, measuring the change in one variable relative to another. As a refresher ROC is represented as **speed** ($\textbf{S}$) or **velocity** ($\textbf{V}$), where ($\textbf{S}$) is the adirectional magnitude (i.e. it is a scalar) of the displacement of an object over unit time and $\textbf{V}$ describes both the direction and magnitude (i.e. it is a vector) of the object's movement in space-time. $\textbf{S}$ is a scalar taking values of $\geq0$ and $\textbf{V}$ can take any value between $-\infty$ and $\infty$. For example, consider a car travelling at a constant speed of $50\frac{km}{h}$ around along a hilly landscape, where it is ascending and descending hills. Although $\textbf{S}$ is constant, $\textbf{V}$ changes in a sinusoidal fashion, where $\textbf{V}$ is $\textbf{V}>0$ when ascending, $\textbf{V}<0$ when descending, and $\textbf{V}\approx0$ at in the valleys and at the peaks of the hills. Although $\textbf{S}$ is useful when estimating other scalar quantities (e.g., $\frac{miles}{gallon}$), given a starting and/or final position in space, $\textbf{S}$ is not informative of its the path traveled. 

### Aims
Here, I propose a method that simply describes the rate of change behavior of system dynamics in phase space: **velocity**, $V$. An alternative to other  model-free approaches [e.g., Fisher Information; @cabezas_towards_2002], the velocity metric allows one to examine the behavior of an entire system along its trajectory 
(through space or time) without having to reconstruct the phase space. The ability to handle noisy and high-dimensional data and the lack of subjective parameters in calculating the metric makes this method an alternative to existing early warning indicators and phase-space reconstruction methods. 

I first describe the steps for calculating this new metric ($V$), as both a dimension reduction technique and abrupt change indicator. Although this is the first instance of this calculation to, alone, be suggested as a regime detection metric, it has been used as part of a larger series of calculations of the Fisher Information metric [see Chapter \@ref(fiGuide)], first introduced in @fath_regime_2003. I use a simple, two-variable system theoretical system to present baseline estimates of the expected  behavior of $V$ under various scenarios. I induce abrupt shifts under varying conditions of changing means and variance of each of these two variables and discuss the contexts under which this metric ($V$) may signal or may fail to signal abrupt changes. Finally, I explore the utility of this metric in identifying known regime shifts in an empirical, high-dimensional paleoecological community time series.

### Analytical approach 
I first describe the steps for calculating velocity by constructing a simple, two-variable system that exhibits only a rapid, discontinuous change in the means of the state variables. I next vary the mean and variance of the state variables of this system to demonstrate baseline expectations for the behavior of velocity under a simple rapid shift scenario. Next, I construct a second model system similar to the first, but one that exhibits a continuous rapid change in the state variables. The purpose of this section is three-fold. First, I demonstrate how velocity behaves when the system undergoes varying degrees of change (e.g., slow change versus nearly discontinuous, rapid). Second, I concurrently identify baseline expectations of velocity under varying conditions of mean and variability of the state variables before and after a shift. Third, by introducing a smoothing function to the rapid shift, we gain an understanding of how process variability (noise) impacts the shift detectability by the velocity metric. Finally, I calculate the velocity of an empirical, paleolithic freshwater diatom community time series to demonstrate the utility of the velocity metric in highly noisy, high dimensional, and irregularly-sampled data. 

## Steps for Calculating velocity, $V$
In this section, I first demonstrate the calculations of velocity using a very simple, two-variable toy system. The first system exhibits a rapid shift at a single point in time, where mean and variance are constant before and after the shift point. I demonstrate the signals achieved with and the variability within the $V$ calculation by exploring a number of scenarios of this simple system. For the examples in this section, observations of $x_i$ are randomly drawn from distribution $x_i\sim Normal(\mu, \sigma)$, where $\mu$ is the mean and $\sigma$ is the standard deviation. 
```{r sysEx, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,   out.width="75%", fig.cap="The 2-variable discrete time toy system used to demonstrate steps for calculating system velocity. Each variable, $x$, is drawn from a normal distribution with means that change at $t = 50$. State variables have constant standard deviation, $\\sigma = 5$."}
x_1 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
x_2 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
t = 1:length(x_1)
df.wide = data.frame(t, x_1, x_2) 
df  = data.frame(t, x_1, x_2) %>% 
  tidyr::gather(key = "variable", value = "value", -t) 

dist <- regimeDetectionMeasures::calculate_distanceTravelled(df %>% mutate(cellID = 1) %>% rename(sortVar = t)) %>% rename(t = sortVar) %>% 
  dplyr::select(-cellID)

# join results with the orig data
df.wide <- left_join(df.wide, dist) %>% 
  # add column for change in variable
  mutate(dx_1 = x_1-lag(x_1),
           dx_2 = x_2-lag(x_2), 
         dt = t - lag(t)) %>%
  dplyr::select(t, x_1, x_2, dx_1, dx_2, dt, everything(), -d2sdt2)
 
# change names of df.wide for table in latex
colnames(df.wide) <- c("t", 
                       "$x_1$",
                       "$x_2$", 
                       "$\\Delta x_1$",
                        "$\\Delta x_2$",
                        "$\\Delta t$",
                        "$\\sqrt(\\sum_{i=1}^N \\Delta x_i^2) $",
                        "$s$",
                        "$V$")
                       # "$s = \\sum_{t=1}^j(\\sqrt(\\sum_{i=1}^N(\\Delta x_i^2))) $",
                       # "$ velocity = \\frac{\\Delta s_{j,j+1}}{\\Delta t}$")
p.sysEx <-ggplot(data =df, aes(x = t, y = value,  linetype=variable, color=variable))+
  geom_line(color="black", size=1)+#data = df, aes(t, value, linetype=variable), color='black')+
  theme(legend.position='bottom')+
  theme_bw()+
     scale_linetype_discrete(
                          labels=c(expression(x[1]), expression(x[2])))
p.sysEx
```

Consider a system (Figure \@ref(fig:sysEx)) with $N$ state variables ($x_i$), with observations taken at time points, $t$. System velocity is calculated as the cumulative sum over time period $t_0$ to $t_j$,  as the total change in all state variables, {$x_1 ...x_N$}, between two adjacent time points, e.g., $t_j$ and $t_{j+1}$, denoted $t_{j,j+1}$. I use this simple, two-variable system to demonstrate how *velocity* is calculated. The system comprises variables $x_1$ and $x_2$, with observations occurring at each time point $t = {1,2,3,...100}$. First, we calculate the change in each state variable, $x_i$, between two adjacent points in time, $t_j$ and $t_{j+1}$, such that the difference, $x_{t_{j+1}} - x_{t_j}$ is assigned to the latter time point, $t_{j+1}$. For example, in our toy data, we use observations at time points $t = 1$ & $t=2$ (Figure \@ref(fig:sysEx2)). For all examples in this chapter, the state variables $x_1$ and $x_2$ were drawn from a normal distribution (using function *rnorm*), with parameters $\bar{x}_i$ (mean) and $\sigma_i$ (sd) for 100 time steps, $t$. Under each scenario I induce a regime shift at time  $t=50$, where  either or both a change in  $\bar{x}_i$ or $\sigma_i$ occurs. 
```{r sysEx2,   cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,  out.width="75%", fig.cap="Data used to calculate velocity at the first two time points, $t_1$ and $t_2$."}
p.sysEx +
  geom_point(size=4, show.legend = FALSE)+
  xlim(c(1,2))+ylim(c(20,50))+
  scale_color_manual(values=c("black","black"))+
  theme(legend.position = 'bottom')+
  theme_bw()
```

### Steps for calculating $V$
#### Step 1: Calculate $\Delta x_i$
The first step is to calculate the change in values for each state variables, $x_i$, between two consecutive time points [e.g., from time $t$ to $t+1$ for the discrete-time system; Figure \@ref(fig:sysEx2); Equation \@ref(eq:diffX)]:
\begin{equation}
\Delta x_i = x_{i(t+1)} - x_{it} 
(\#eq:diffX)
\end{equation}
Note that $\Delta x_i$ can take any value between $-\infty$ and $\infty$. 

#### Step 2: Calculate distance traveled, $s$
Next, we calculate the total change in the multivariate system as a function of the change in all  state variables $x_i$. First, we calculate $\Delta s$ as the square root of the sum of squares of the changes in all state variables per Pythagoras's theorem [Equation \@ref(eq:ds)]: 
\begin{equation}
\Delta s = \sqrt{\sum{\Delta x_i^2}}
(\#eq:ds)
\end{equation}
Although $\Delta s$ represents the absolute change in the system between consecutive points in time, this measure is not yet relative along the system's trajectory. To create a relative value we next calculate the total distance traveled along the system trajectory, $s$, as the cumulative sum of $\Delta s$ [Equation \@ref(eq:ds)] since the first observation, such that a cumulative sum is calculated for every $t$ over the interval $[0,T]$ [Equation \@ref(eq:s)]:
\begin{equation}
s_T = \Sigma_{t=0}^{T}{\Delta s}
  (\#eq:s)
\end{equation}

```{r sysExs, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,  out.width="75%", fig.cap = "Distance traveled, $s$, for the 2-species toy system."}
temp <- df %>%
  group_by(variable) %>% 
  arrange(t) %>% 
  mutate(dx2 = ((value)-lag(value))^2) %>% 
  ungroup() %>% 
  group_by(t) %>% 
  mutate(ds = sqrt(sum(dx2))) %>% 
  distinct(t, ds) %>% 
  ungroup() %>%
  arrange(t)
temp[1,"ds"]=0
temp <- temp %>% 
  mutate(s = cumsum(ds))

ggplot(temp, aes(x=t, y=s))+
  geom_line(size=1)+
  theme_Publication()+
  geom_line(aes(x=50), color="grey40", linetype=2)+
  xlab("t")
```

We now have a single measure, $s_T$ [hereafter referred to as $s$; Equation \@ref(eq:s)] at each discrete point in time in our $N$-dimensional system (Figure \@ref(fig:sysExs)). It should be noted that $s$(Figure \@ref(fig:sysExs)) is monotonically increasing since the value of $\Delta s$ [Equation \@ref(eq:ds)] is a sum of squares. Although discussed in a later section, it is important to note that $s$ is not unitless---that is, $s$ has units of the state variables, $x_i$. For example, if our 2-variable toy system represents biomass, then the units of $s$ represents the cumulative absolute change in biomass of the entire system. 

#### Step 3: Calculate velocity, $V$ (or $\frac{\Delta s}{\Delta t}$) 
Finally, we calculate the **system velocity**, $V$ (or $\frac{\Delta s}{\Delta t}$), by first calculating the change in $s$ [Equation \@ref(eq:s)], and then divide  by the total time elapsed between consecutive sampling points:
\begin{equation}
 v = \frac {\Delta s}{\Delta t} 
(\#eq:velocity)
\end{equation}

```{r velocSysEx1,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,  out.width="75%", fig.cap = "System change ($s$) and velocity ($V$) of the model system over the time period. Constant means ($\\bar{x}_{pre}=25$, $\\bar{x}_{post}=10$) and sharp change in variance for both state variables, $\\sigma =5$."}
# x_1 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
# x_2 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
# t = 1:length(x_1)
# df.wide = data.frame(t, x_1, x_2)
# df  = data.frame(t, x_1, x_2) %>%
#   tidyr::gather(key = "variable", value = "value", -t)
# 
# dist <- df %>%
#   mutate(cellID = 1) %>%
#   rename(sortVar = t) %>%
#   regimeDetectionMeasures::calculate_distanceTravelled()
# 
# p<- dsdtPlot(dist=dist, df=df, div = 1)+
#   ggtitle(
#   expression(paste("changing means, constant variance"))
# )+
#      scale_linetype_discrete(
#                           labels=c(expression(x[1]), expression(x[2])))
# p
# ggsave(p, filename=paste0(here::here("chapterFiles/velocity/figsCalledInDiss/velocitySysEx1.png")))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/velocitySysEx1.png"))
```

```{r distTab, eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE,  message=FALSE}
library(kableExtra)
options(knitr.kable.NA = "")
kable(df.wide[1:5,],digits=3, "latex", align="c", booktabs=TRUE, escape = FALSE, 
            caption = 'Steps outlined for calculating system velocity, $V$, using the 2-variable toy data as an example.')
```

The numerical results for each step in the calculation of velocity [Equation \@ref(eq:velocity)] is demonstrated using the first five time points of our toy system (Figure \@ref(fig:sysEx)) in Table \@ref(tab:distTab). 

## Velocity *v* performance under a discontinuous transition 
I used simulation techniques to determine the baseline expectations of the performance of velocity $V$ under varying degrees of rapid shifts in the mean and variance of the toy system. The toy system in this section undergoes a discontinuous shift at $t = 50$ (see \@ref(fig:sysEx)). If the system undergoes a rapid and discontinuous change in one or more state variables, the velocity, because it is a rate of change, has the potential to approach $\infty$ as $\Delta t \rightarrow 0$. Therefore, it is important to understand the degree to that velocity can detect very sudden changes in mean values, despite effect sizes. Here, I varied  each of the following system parameters at the regime shift location ($t=50$): $\bar{x}_1$, increase in the mean value of $x_1$ and $\sigma_1$, the change in variance of $x_1$.

Simulations consisted of 10,000 random samples drawn from the normal distribution for each parameter, I randomly drew the toy system samples 10,000 times under increasing values of $\bar{x}_1$ and $\sigma_1$. To identify patterns in the influence of parameter values on velocity, I present the mean values of $V$ across all simulations, with confidence intervals of $\pm 2$ standard deviations. As mentioned above, the state variables $x_1$ and $x_2$ were drawn from a normal distribution (using function *rnorm*), with parameters $\bar{x}_i$ (mean) and $\sigma_i$ (sd) for 50 time steps, $t$. 

#### Varying post-shift mean
I examined the influence of the magnitude of change in $x_1$ in the period before (pre; $t <50$) and after (post; $t \geq 50$) by varying the mean parameter, $\bar{x}_1$ in the set $W=\{25,30,35,...100 \}$ (Figures \@ref(fig:simVplot1) and \@ref(fig:simVplot2)). As expected, the magnitude of $V$ increases linearly as the total difference between $\bar{x}_{1_{pre}}$ and $\bar{x}_{1_{post}}$ increases (Figure \@ref(fig:simVplot2)). This is not surprising because  $s$ increases as the total change in abundance across the entire system increases [Equation \@ref(eq:s)]. Consequently the potential  of $V$ also increases with total state variable values (e.g. abundance, biomass). The linear relationship among $V$ and total state variable values indicates that while $V$ is capable of identifying large shifts in data structure, it may fail to identify subtle changes (i.e. lower effect sizes).
```{r simVplot1, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "Velocity ($V$) generally increases as the total change in the mean value of $\\bar{x}_{1_{t=50}}$ increases in a single iteration of our toy system ($N_{iter}=1$, seed = 123). This 2-variable system exhibits a regime shift at $t=50$, where variance is constant $\\sigma = 5$, $\\bar{x}_1 = 25$ when $t<50$,  $\\bar{x}_2=50$ when $t\\geq50$, $\\bar{x}_1 = 25$ when $t <50$.", out.width="75%"}
# p<- ggplot(data = dist.sim %>% filter(sim.num==1, t==51), 
#        aes(x = as.integer(mean.sim), y = dsdt))+
#   geom_line()+
#   theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste("total change in ", bar("x")[1], " at ", italic("t = 50"))))
# ggsave(p, filename=paste0(figDir,"simVplot1.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVplot1.png"))
```

```{r simVplot2, cache = TRUE, echo=FALSE, warning=FALSE, out.width="75%", eval=TRUE, message=FALSE, fig.cap = "Change in velocity ($V$) as the total change in the mean value of $\\bar{x}_{2_{t=50}}$ over 10,000 simulations. A regime shift was induced at $t=50$ with constant varoance $\\sigma = 5$, $\\bar{x}_2 = 25$ when $t<50$,  and changes in variable mean values, $\\bar{x}_2 = 50$ when $t \\geq 50$, $\\bar{x}_1 = 25$ when $t<50$."}
# dist.sim.reduced <- dist.sim %>% filter(t==51) %>% 
#          group_by(mean.sim) %>% 
#          mutate(dsdt.sim.mean  = mean(dsdt), 
#                 sd.sim    = sd(dsdt), 
#                 lower     = dsdt.sim.mean - 1.96*sd.sim, 
#                 upper     = dsdt.sim.mean + 1.96*sd.sim
#                 ) %>% 
#          distinct(mean.sim, sd.sim, lower, upper, dsdt.sim.mean) %>% 
#   ungroup() %>% 
#   mutate(mean.sim = as.integer(mean.sim))
# 
# p<- ggplot(data = dist.sim.reduced)+
#  geom_ribbon(aes(x = mean.sim, ymin = lower , ymax = upper), fill = "grey70") +
#     geom_line(aes(x = mean.sim,  y = dsdt.sim.mean))+
#     theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste("total change in ", bar("x")[1], " between ", italic("t = 50"), " and ", italic("t = 51"))))+
#   ggtitle(expression(paste("Mean ",  italic("v")," (±2SD) over ", 10,000, " iterations")))
# ggsave(p, filename=paste0(figDir,"simVplot2.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVplot2.png"))
```

```{r simVar,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
# files <- list.files("./chapterFiles/velocity/simResults", pattern= "var_x1")
# if(!exists("quickRun")) quickRun <- NULL
# if(exists("files")& !is.null(files)) quickRun=FALSE
# if(quickRun) files <- files[1:500] # when knitting thesis for minor edits...
# 
# if(length(files) ==0){
#   var.analy = TRUE
#   source("./chapterFiles/velocity/06-chap-velocity_exampleAnalysis.R")
# }
# if(quickRun){
# dist.sim <- do.call("rbind", lapply(paste0("./chapterFiles/velocity/simResults/",files),
# 		feather::read_feather))
# dist.sim <- saveRDS(dist.sim, "./chapterFiles/velocity/simResults/distSim_varx1.RDS")
# }

# dist.sim2 <- readRDS( "./chapterFiles/velocity/simResults/distSim_varx1.RDS")
# dist.sim.reduced2 <- dist.sim2 %>% filter(t==51) %>% 
#          group_by(var.sim) %>% 
#          mutate(dsdt.sim.mean  = mean(dsdt), 
#                 sd.sim    = sd(dsdt), 
#                 lower     = dsdt.sim.mean - 1.96*sd.sim, 
#                 upper     = dsdt.sim.mean + 1.96*sd.sim
#                 ) %>% 
#          distinct(var.sim, sd.sim, lower, upper, dsdt.sim.mean) %>% 
#   ungroup() %>% 
#   mutate(var.sim = as.integer(var.sim))
```

#### Varying post-shift variance
In the previous example, variance was constant before and after the abrupt shift at $t=50$. To determine whether the signal emitted by $V$ at the regime shift is lost or dampened when increasing variance I varied the variance parameter, $\sigma_1$ along the set $W = \{1,2,3,...25 \}$. The variance for both state variables ($x_1, x_2$) prior to the regime shift, $\sigma_{x_1}$ and $\sigma_{x_2}$, was $5$, with the change occurring in $\sigma_{x1post}$.
```{r simVarPlot, echo=FALSE,  eval=TRUE,   out.width="75%", fig.cap = "High variance of velocity ($V$) in a single iteration ($N_{iter}=1$, seed = 123) of simulations as we increase $\\sigma_1$ at $t=50$."}
# p<- ggplot(data = dist.sim2 %>% filter(sim.num==1, t==51), 
#        aes(x = as.integer(var.sim), y = dsdt))+
#   geom_line()+
#   theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste(
#     # italic("W"), 
#     "total change in ", "sigma"[1], " at ", italic("t = 50"))))
# ggsave(p, filename=paste0(figDir,"simVarPlot.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVarPlot.png"))
```

```{r simVarPlot2,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,   out.width="75%", fig.cap = "The variance around the average ($\\pm2$ SD) velocity ($V$) increases as the variance of $\\bar{x}_{2_{t=50 (post)}}$ (post shift) increases. $\\bar{x}_{1_{pre}} = 25$, $\\bar{x}_{1_{post}} = 100$, $\\bar{x}_{2_{pre}} = 25$, $\\bar{x}_{2_{post}} = 50$, $\\sigma_{1_{pre}} = 5$, $\\sigma_{2_{pre,post}} = 5$"}
# p<- ggplot(data = dist.sim.reduced2)+
#  geom_ribbon(aes(x = var.sim, ymin = lower , ymax = upper), fill = "grey70") +
#     geom_line(aes(x = var.sim,  y = dsdt.sim.mean))+
#     theme_bw()+
#   xlim(c(1,25))+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste(sigma, " ", bar("x")[1], " at ", italic("t = 50"))))+
#   ggtitle(expression(paste("Mean ",  italic("v")," (±2SD) over ", 10,000, " iterations")))
# 
# ggsave(p, filename=paste0(figDir,"simVarPlot2.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVarPlot2.png"))
```

#### Smoothing the data prior to calculating *v*
To determine whether process or observational noise influences the signal in $V$, I used linear approximation techniques to smooth the data prior to calculating the derivatives. I used the function `stats::approx` that linearly interpolates the original data, $x_1$ and $x_2$, to regularly-spaced time points along  the set $t=\{1:100\}$. I then calculated $V$ as described in (Eqs. \@ref(eq:diffX) through \@ref(eq:velocity)). Increasing the number of points ($t$) at that the original state variables were smoothed (i.e., $t$) did not influence the amount of noise surrounding the signal of the regime shift (at $t=50$) in system velocity, $V$ (Figure \@ref(fig:simVarPlot2)).
```{r smoothV, eval=FALSE, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE,  out.width="75%", fig.cap = "The noise in system velocity ($V$) is not obviously reduced in this system as the original data ($x_1$, $x_2$) is increasingly smoothed."}
# smoothed <- approx_dist.sim(t.mult = 1)
# p1<- dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("no smoothing")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 2)
# p2<- dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 2X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 5)
# p3<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 5X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 10)
# p4<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 10X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 100)
# p5<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 100X")
# p<- cowplot::plot_grid(p1,p2,p3,p4,p5)
# ggsave(p, filename=paste0(figDir,"smoothV.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/smoothV.png"))
```

## Velocity performance under a smooth transition
In the previous section I presented expectations for velocity signals under a discontinuous transition in a discrete-time system. Given velocity is a measure of the rate of a change in a system and the range of transition speeds ecological systems exhibit (e.g., slow driver-response or threshold dynamics), it is important to understand if and when the velocity signal is dampened under varying degrees of transition speeds. In this section I use a similar toy system, to demonstrate the expectations of velocity under a smooth shift and under varying degrees of rapidity.

Although the data constructed in this section are similar to that used in the previous section in that we are manipulating the mean and variance of two state variables before and/or after an abrupt shift, this section introduces a component of process noise into the shift itself. This is important because the derivative of a nearly discontinuous function is infinite. Although we are interested in identifying rapid shifts in systems, velocity will approach infinity as the rate of change in the shift increases and the sampling intervals decrease. In other words, if the system exhibits turnover in e.g. $25\%$ of the state variables, we expect the value of velocity to be similar to that of a turnover in e.g. $75\%$ of the variables. Removing the possibility of infinite values provides more relative measures within the community time series. 

### Generating the data
Here we consider a two-variable system over the time interval $[1,100]$ with state variables $x_1$ and $x_2$ that exhibits abrupt shifts in mean and/or variance of one or both variables at time $t=50$. I generated species observations for the true process and  the true process with process variability. The true process data were created using the parameters for $\mu$ and $\sigma$ for each of the conditions in described in Table \@ref(tab:sysParams) (random seed in Program R was 12345).
```{r sysParams, echo=FALSE, eval=TRUE, cache=TRUE}
params <- data.frame(
  sd.perc_1a = c(0.05, 0.05, 0.05, 0.05, 0.05,  0.05), # percent of the mean will determine the sd_1a ... sd_2b
  sd.perc_1b = c(0.10, 0.10, 0.05, 0.05, 0.10,  0.10),
  sd.perc_2a = c(0.05, 0.05, 0.05, 0.05, 0.05,  0.05),# percent of the mean will determine the sd_1a ... sd_2b
  sd.perc_2b = c(0.10, 0.05, 0.05, 0.05, 0.10,  0.05),
       mu_1a = c(10,     10,   10,   10,   10,  10),
       mu_1b = c(55,     55,   55,   55,   10,  10),
       mu_2a = c(15,     15,   15,   15,   15,  15),
       mu_2b = c(44,     15,   44,   15,   15,  15)
)

colnames(params) <- c(
  "$\\sigma_{x_{1_{pre}}}$",
  "$\\sigma_{x_{1_{post}}}$",
  "$\\sigma_{x_{2_{pre}}}$",
  "$\\sigma_{x_{2_{post}}}$",
  "$\\mu_{x_{1_{pre}}}$",
  "$\\mu_{x_{1_{post}}}$",
  "$\\mu_{x_{2_{pre}}}$",
  "$\\mu_{x_{2_{post}}}$"
)

conditions <-c( 
  "$\\mu_{x_1}$, $\\mu_{x_2}$, $\\sigma_{x_1}$, $\\sigma_{x_2}$", 
  "$\\mu_{x_1}$, $\\sigma_{x_1}$", 
  "$\\mu_{x_1}$, $\\mu_{x_2}$", 
  "$\\mu_{x_1}$", 
  "$\\sigma_{x_1}$, $\\sigma_{x_2}$", 
  "$\\sigma_{x_1}$" 
)   
myTab <- cbind(conditions, params)
require(kableExtra)
options(knitr.kable.NA = "")
kable(myTab,digits=2, "latex", align="l", booktabs=TRUE, escape = FALSE,
            caption = 'Conditions for generating various scenarios of the hyperbolic tangent-induced abrupt change. $\\sigma_i$ represents the standard deviation of $\\mu_{x_i}$ as the percent of $\\mu_{x_i}$, $\\mu_{x_i}$ is the mean of the state variable, $x_i$, and pre and post represent the periods before and after the regime shift at $t=50$, respectively.')
```

#### True process model
Data were generated from a normal distribution and an abrupt shift in the mean was incorporated using a hyperbolic tangent function. The true process for each state variable, $x_i$, was generated from [Equation \@ref(eq:true); see Figure \@ref(fig:trueObsEx)]:
\begin{equation}
\begin{array}{rcl}
\mu_{xipre}\sim Normal(\mu_{xipre},\sigma_{xipre}) \\ 
\mu_{xipost} \sim Normal(\mu_{xipre}, \sigma{xipost}) \\ 
\mu_{x_i}(t) = \mu_x{_ipre}  - 0.5(\mu_x{_ipre}-\mu_{xipost})(\tanh(\alpha (t-t_{shift}))+1) \\ 
\end{array}
(\#eq:true)
\end{equation}

where $\mu_{x_i}(t)$ is the mean value of $x_i$ at time $t$ and *pre* and *post* are the periods before and after the abrupt shift ($t_{shift}$), respectively. The parameter $\alpha$ in Equation \@ref(eq:true) controls for the rate of change at the point of the abrupt change, $t_{shift}$, where higher values of $\alpha$ correspond with a higher slope at $t_{shift}$. I simulated a single iteration (data set) for various conditions of changing $\mu_{xi}$ and  $\sigma_{xi}$ (see  Table \@ref(tab:sysParams)), for two state variables $x_1\ \&\ x_2$ at intervals of $t=1$ along the temporal interval $t=[1,100]$.
```{r trueObsEx, echo=FALSE, warning=FALSE, message=FALSE, cache = TRUE,   out.width="75%", fig.cap="An example of the data generated by the true process model. In this example the mean values ($\\mu_{xi}$), but not the percent standard deviation ($\\sigma_{xi}$), are varied before and after the transition point. The observed data are plotted against the true-process model for each state variable, $x_i$. Panels represent different degrees of the smoothing parameter, $\\alpha$ (top: $\\alpha=0.25$, bottom:$\\alpha=1.00$)."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuBoth_tanhAlpha025-05tvdiffAlpha-1000iter_origDat.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuBoth_tanhAlpha1-100tvdiffAlpha-1000iter_origDat.png"))
```

#### Observed process data
I generated observations by imputing noise into the true process model [Equation \@ref(eq:true)] through random sampling of $\sigma_x{_i}$ from a normal distribution [Equation \@ref(eq:observed); Figure \@ref(fig:trueObsEx)]:
\begin{equation}
\begin{array}{rcl}
\mu_{xipre}\sim Normal(\mu_{xipre},\sigma_{xipre}) \\ 
\sigma_{xipre} \sim Normal(0,\sigma_{Xipre}\mu_{Xipre}) \\
\mu_{xipost} \sim Normal(\mu_{ipost},\sigma_{ipost}) \\ 
\sigma_{xipost} \sim Normal(0,\sigma_{Xipost}\mu_{xipost}) \\
\mu_{xi}(t) = \mu_x{_ipre}  - 0.5(\mu_{xipre}-\mu_{xipost})(\tanh(\alpha (t-t_{shift}))+1) \\
\end{array}
(\#eq:observed)
\end{equation}

where $\sigma_{xi}$ is the observed error around $\mu_{xi}$, and $\sigma_{Xi}$ is $X\%$ of $\mu_{xi}$ under various sampling conditions (as described in Table \@ref(tab:sysParams)). I generated the error as a percent of the mean as this scaling relationship is commonly observed in ecological data [@taylor1961aggregation].  

### Evaluating velocity performance under conditions of changing means and/or variance
I simulated a single data set (using `r set.seed=12345` in Program R) by randomly drawing a single realisation (observed data) of the hyperbolic tangent process model with additive noise process [Equation \@ref(eq:observed)]. I then calculated the distance traveled, $s$, and the velocity of the distance traveled, $V$ (also referred to as $\frac{ds}{dt}$) using Equation \@ref(eq:velocity)---this approach (Equation \@ref(eq:velocity)) is a simple alternative to numerical integration techniques, requiring only simple algebraic techniques. This method is ideal for discrete time data, or where computational power would not suffice for numerical integration. When using the first differences method, however, $V$ will demonstrate high variability, depending on the amount of time between samples (i.e. as the intervals of $t-t+1$ increase). 

I also calculated $V$ using a numerical integration method for non-smooth, noisy data, called total variation regularized differentiation [@chartrand2011numerical]. I used the R package `tvdiff` [@price2019tvdiff] to perform  numerically integrate the distance traveled, $s$. The regularized differentiation method in this package [function `tbdiff::tvRegDiff`; described fully in @chartrand2011numerical] provides a numerical solution for calculating non-noisy derivatives of noisy, non-smooth data. Using this smooth-derivative estimation technique may be an ideal supplement to the velocity method in cases where process and observational error generate noisy observational data. Although not possible in most ecological systems data, here we can compare the fit of the smooth-derivative to the derivative of the true process, allowing us to determine the usefulness of calculating a smooth-derivative. There are two tuning parameters required to be chosen by the analyst when implementing the total-variation regularized differentiation, each of that influence the amount of noise smoothed out in the resulting derivative: $\alpha$ and the number of iterations. I implemented this numerical differentiation over 1,000 iterations, and selected $\alpha$ by comparing the anti-differentiated distance traveled, $s$, to the true process values of $s$ (e.g., see Figure \@ref(fig:antiDiffComp)). For most conditions and smoothness I found the tuning parameter for `tvdiff` $\alpha=0.50$ provided a good fit of $s$ (Figure \@ref(fig:antiDiffComp)), however, when the hyperbolic tangent smoothing parameter, $\alpha$ was low (i.e. $\alpha_{tanh}=0.25$) higher values of $\alpha_{tvdiff}$ yielded more abrupt changes in the derivative. 
```{r antiDiffComp, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE,   out.width="75%", fig.cap="Antidifferentiated values ('observed') of the distance traveled, $s$, to the true process values of $s$ ('true) provides a method for identifying the best values of the smooothing parameter, $\\alpha$. Under most conditions $\\alpha \\ll$ sufficed. Here, we compare the true and antidifferentiated values of $s$ under the condition of changing $\\mu_{x1}$ when the hyperbolic tangent function is most rapid ($\\alpha_{tanh}=1$) for the `tvdiff` $\\alpha=0.50$. Not pictured: the antidifferentiated values of $s$ (observed) is increasingly smoothed as $\\alpha$ increases."}
knitr::include_graphics(here::here("/chapterFiles/velocity/figsCalledInDiss/compareTvdiff_s_changeMuX1_tanhAlpha1-05tvdiffAlpha-1000iter.png"))
```
```{r antiDiffComp2, echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE, out.width="33%"}
# knitr::include_graphics(here::here("/chapterFiles/velocity/figsCalledInDiss/compareTvdiff_s_changeMuX1_tanhAlpha1-1tvdiffAlpha-1000iter.png"))
```
```{r antiDiffComp3, eval=FALSE, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE, out.width="33%"}
# knitr::include_graphics(here::here("/chapterFiles/velocity/figsCalledInDiss/compareTvdiff_s_changeMuX1_tanhAlpha1-10tvdiffAlpha-1000iter.png"))
```
```{r mu1varpt25, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is muted when the  hyperbolic smoothing parameter, $\\alpha$, is low (0.25). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuX1_tanhAlpha025-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```
```{r mu1varpt5, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is muted when the  hyperbolic smoothing parameter, $\\alpha$, is moderate (0.50). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuX1_tanhAlpha05-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```

#### Smooth changes in the mean
As discussed earlier, the velocity of the distance traveled, $V$, is a measure of how quickly the sum of the squared system variables change between observations (i.e. time). Consequently, as the total change in state variables grows, so will the maximum potential of the velocity, $V$. Following this logic, we should expect to see a spike in the derivative of the distance traveled when the system changes quickly. I tested this hypothesis under two conditions of changing means, where either one or both variables underwent mean shifts (see Table \@ref(tab:sysParams)), and under varying degrees of transition smoothness (i.e. $\alpha_{tanh}={0.25, 0.50, 0.75, 1.00}$). 

```{r mu1varpt75, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is muted when the  hyperbolic smoothing parameter, $\\alpha$, is moderate (0.50). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuX1_tanhAlpha075-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```
```{r mu1var1, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is muted when the  hyperbolic smoothing parameter, $\\alpha$, is moderate (0.50). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuX1_tanhAlpha1-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```
```{r muBoth25, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is regained under smoooth transition ($\\alpha_{tanh}=0.25$) when both state variables undergo a shift in the mean. True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuBoth_tanhAlpha025-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```
```{r muBoth75, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signal is regained under smoooth transition ($\\alpha_{tanh}=0.75$) when both state variables undergo a shift in the mean. True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuBoth_tanhAlpha075-05tvdiffAlpha-1000iter_stackTvdiff.png"))
```

When the hyperbolic tangent smooth transition function is less steep (Figure \@ref(fig:mu1varpt25)) the observed velocity signal is dampened. This signal, however, quickly recovers when the transition function becomes more abrupt (Figures \@ref(fig:mu1varpt5), \@ref(fig:mu1varpt75) ,\@ref(fig:mu1var1); $\alpha_{tanh}=0.5, 0.75, and 1.00$, respectively). The signal of velocity as an indicator of abrupt change appears more rapid when the mean of both state variables (Figure \@ref(fig:muBoth25)), rather than a single (Figure \@ref(fig:mu1varpt25)), are shifted (assuming  constant variance). Figure \@ref(fig:muBoth75) is representative of the increasing signal in velocity as $\alpha_{tanh}$ increases. 
```{r varBoth, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signals a rapid shift in the variance of both state variables under a moderately abrupt transition ($\\alpha_{tanh}=0.75$). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeVarBoth_tanhAlpha075-5tvdiffAlpha-1000iter_stackTvdiff.png"))
```
```{r var1, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity does not signal shifts in the variance of a single variable ($x_1$) under a moderately abrupt transition ($\\alpha_{tanh}=0.75$). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D). "}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeVarX1_tanhAlpha075-10tvdiffAlpha-1000iter_stackTvdiff.png"))
```

#### Smooth changes in variance
Abrupt changes sometimes manifest first as a change in the variability, rather than the mean value, of the state variables. This condition manifests in the velocity signal when both variables experience a shift in relative variance (Figure \@ref(fig:varBoth)), however, velocity does not signal change when only one variable exhibits a shift in variance (Figure \@ref(fig:var1)). Again, given the total magnitude of change influences the distance traveled, $s$, and the derivative of s, $V$, it is not surprising that the velocity signal is greater around the transition point when both, compared to a single, state variable exhibits increased variability about the mean. In these scenarios I shifted the variability in the state variables $x_i$ from only $\sim 5\%$ to $\sim10\%$ (see Table \@ref(tab:sysParams))---this percent variability is low relative to most empirical observational ecological data sets. As such, I expect the velocity signal to be more pronounced when empirical systems undergo shifts in variance in at least one state variable.

#### Smooth changes in the mean and variance
Given the signals identified in the velocity when one or both state variables exhibits a shift in mean and/or variance, it is unsurprising that even under smooth transitions (when $\alpha_{tanh} = 0.25$), velocity manifests as a signal of change (Figure \@ref(fig:muVarBoth25)). This signal is most pronounced when the shift is abrupt (Figure \@ref(fig:muVarBoth1)).
```{r muVarBoth25, echo=FALSE, warning=F, message=F, cache = T,  out.width="75%", fig.cap="The velocity signals a shift when both variables undergo shifts in the mean and variance under a slightly abrupt transition ($\\alpha_{tanh}=0.25$). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D)."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuVarBoth_tanhAlpha025-5tvdiffAlpha-1000iter_stackTvdiff.png"))
```

```{r muVarBoth1, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="The velocity signals a shift when both variables undergo shifts in the mean and variance under a slightly abrupt transition ($\\alpha_{tanh}=1.00$). True and observed values of $x_i$ (panel A), observed distance traveled ($s$, panel B), observed velocity (C), and the smoothed velocity (D)."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/changeMuVarBoth_tanhAlpha1-10tvdiffAlpha-1000iter_stackTvdiff.png"))
```

## Velocity performance under empirical transitions: paleolithic freshwater diatom community
```{r tvDiffPaleoCalculate, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
library(tvdiff)
library(tidyverse)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())

# Load data
regimeDetectionMeasures::munge_orig_dat()
data("paleo")

# Linear interpolate data 
xout <- seq(min(paleo$sortVar), max(paleo$sortVar), length.out = 700)
paleoInterp <- 
  paleo %>%
  dplyr::select(-cellID, -site) %>% 
  rename(t = sortVar, y = value) %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(
    t = purrr::map(data, ~ approx(.$t, .$y, xout = xout)$x, rule = 1),
    y = purrr::map(data, ~ approx(.$t, .$y, xout = xout)$y, rule = 1)
  ) %>%
  dplyr::select(-data) %>%
  unnest()

# Calculate distance
paleoDistance <- 
  paleoInterp %>% 
  group_by(variable) %>% 
  mutate(dy = lead(y) - y,
         dt = lead(t) - t) %>% 
  group_by(t) %>% 
  summarize(ds = sqrt(sum(dy^2))) %>% 
  mutate(s = cumsum(ds)) %>% 
  dplyr::select(-ds) %>% 
  na.omit()

# Build dataframe
paleoEx <-
  paleoDistance %>% 
  mutate(dt = lead(t) - t) %>% 
  # Estimate derivative
  mutate(dsdt =
           TVRegDiffR(
             data = s,
             iter = 2e3,
             alph = 100,
             scale = "small",
             ep = 1e-6,
             dx = dt[1]
           )[-1]) %>% 
  # Simple numerical integration
  mutate(pred = s[1] + cumsum(dsdt*dt)) %>% 
  # Collect in long form
  gather(key, value, -t, -dt)
```
```{r paleoTurnover, echo=FALSE, warning=F, message=F, cache = T,   out.width="75%", fig.cap="Relative abundances of the most common diatom species in the time series. Few species dominate the data over the entire time series, and turnover is apparent at multiple observations."}
# topSpecies <-
#   paleo %>%
#   group_by(variable) %>%
#   summarize(q95 = quantile(value, 0.95)) %>%
#   arrange(desc(q95))
# topSpecies <- topSpecies[1:10,]
# plotData <-
#   paleo %>%
#   mutate(variable = if_else(variable %in% topSpecies$variable, variable, "Other (n = 99)")) %>%
#   mutate(variable = factor(variable, levels = c(sort(topSpecies$variable), "Other (n = 99)"))) %>%
#   group_by(sortVar, variable) %>%
#   summarize(value = sum(value)) %>% 
#   mutate(year.plot = -1*sortVar)
# 
# # Generate top species abundance plot to see turnover
# p<-
#    ggplot(data = plotData,
#           aes(x = year.plot, y = value, fill = variable)) +
#    geom_area() +
#    geom_rug(sides = "b") +
#    scale_fill_brewer(palette = "Paired") +
#      theme_bw()+
#    theme(legend.position = "top") +
#    labs(x = "years before 1950", y = "relative abundance", fill = "variable")+
#      scale_x_reverse()
# ggsave(p, filename=paste0(figDir,"paleoTurnover.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoTurnover.png"))
```

To gather baseline information on the use of velocity in empirical systems data, I calculated velocity for the paleodiatom system described in Chapter \@ref(resampling) (see also Appendix \@ref(appPaleo)). Briefly, the paleodiatom community comprises `r length(unique(paleo$variable))` time series over a period of approximately `r abs(max(paleo$sortVar)-min(paleo$sortVar)) %>% round(0)` years (Figure \@ref(fig:paleoTurnover)). As elaborated in @spanbauer_prolonged_2014, the paleodiatom community is suggested to have undergone regime shifts at multiple points. These abrupt changes are apparent when exploring the relative abundances over time, as there are extreme levels of species turnover at multiple points in the data (Figure \@ref(fig:paleoTurnover)). Using Fisher Information and climatological records, @spanbauer_prolonged_2014 suggest that regime shifts in this system at approximately 1,300 years before present [where years before present is equal to year 1950; @spanbauer_prolonged_2014].
```{r paleoVelocity,  echo=FALSE, warning=F, message=F, cache = T,    out.width="75%", fig.cap ="Velocity $V$ and distance traveled $s$ of the paleodiatom time series. Dashed line at 1,300 years before 1950 indicates the regime shift identifed in Spanbauer et al. (2014). Dotted lines indicate regime shifts as visually identified on metrics $s$ and $V$."}
# plotData <- regimeDetectionMeasures::calculate_distanceTravelled(paleo) %>% na.omit(d2sdt2) %>% 
#   rename(acceleration= d2sdt2, 
#          v = dsdt) %>% 
#   gather(key ="key", value="value", -cellID,-sortVar) %>% 
#   filter(!key %in% c("acceleration","ds"))
# 
# p<- ggplot(plotData, aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   facet_wrap(~key, ncol=1, scales="free_y", strip.position="left")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#      scale_x_reverse()+
#   geom_vline(xintercept = 1300, color="red",size=.8, linetype=2)+
#   geom_vline(xintercept = c(1383, 2150, 4800), color="blue",linetype=3, size=.8)
# ggsave(p, filename=paste0(figDir,"paleoVelocity.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoVelocity.png"))
```
```{r paleoRegime1and3,  echo=FALSE, warning=F, message=F, cache = T,    out.width="75%", fig.cap ="Inter-regime (regimes A and B) trends inthe velocity signal ($V$) indicate the fluctuating decadal and centurial abiotic conditions discussed in @spanbauer_prolonged_2014."}
# p1=ggplot(plotData %>% filter(sortVar < -5000, key=="v"), aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#  annotate("text", x=6800, y=0.10, size=4.5, label= expression(bold("")))+ 
#      scale_x_reverse()
# 
# p2=ggplot(plotData%>% filter(sortVar < -1250, sortVar > -2200, key=="v"), aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#  annotate("text", x=2125, y=0.20, size=4.5, label= expression(bold("")))+ 
#      scale_x_reverse()
# p<- cowplot::plot_grid(p1, p2, ncol=1, labels="AUTO")
# 
# ggsave(p, filename=paste0(figDir,"paleoRegime1and3.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoRegime1and3.png"))
```

@spanbauer_prolonged_2014 used different regime detection metrics coupled with regional climatological events to identify regime shifts in the system, suggest that a regime shift occurred at ~1,300 years before present. Using the methods outlined above, I calculated the distance traveled ($s$) and velocity ($V$; Figure \@ref(fig:paleoV)). The results of $V$ and $s$ (Figure \@ref(fig:paleoVelocity)) on the relative abundance data correspond with both the large shifts in species dynamics (see Fig \@ref(fig:paleoTurnover), and also with the regime shift identified by @spanbauer_prolonged_2014. However, two primary results can be made from the metrics  $V$ and $s$ that are not obvious nor identified numerically in the results of @spanbauer_prolonged_2014: 

1. Two additional large shifts occurred at approximately 2,500, 4,800 and years before 1950       
1. The periods before the first and after the second large shifts appear oscillatory (Figure \@ref(fig:paleoRegime1and3)).

To determine the effect of dampening the noise in the data on the velocity signal, I interpolated the each time series using function `stats::approx` to 700 time points. Next, I calculated the distance traveled of the entire system, $s$. Finally, I obtained the derivative of $s$ by using a regularized differentiation (using function `tvdiff::TVRegDiffR`; parameters were $iter = 2000$, scale = small, $ep = 1 x 10^-6$, and $\alpha = 100$). This method of regularized differentiation is an ideal approach to smoothing $s$ because it assumes the data are non-smooth and incorporates finite differencing. The total variation regularized differentiation is described in @chartrand2011numerical, @price2019tvdiff, and in the previous first-level section.
```{r paleoObsPred, eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE,  message=FALSE,   out.width="75%", fig.cap = "The regularized differentiation of $s$ was best fit using $\\alpha = 100$. Higher overlap of $s$ and pred indicates a good fit of the regularized differentiated metric to the non-smoothed metric, $s$."}
# Plot observed vs predicted
# p=ggplot(paleoEx %>% 
#          filter(key %in% c("s", "pred")), 
#        aes(x = t, y = value, color = key, linetype = key)) +
#   geom_line(size = 1.2) +
#   labs(x = "time",
#        y = "cumulative change in state (s)")
# ggsave(p, filename=paste0(figDir,"paleoObsPred.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoObsPred.png"))
```

The smoothed velocity (Figure \@ref(fig:paleoV)) provides a similar but smoother picture of the velocity of the system trajectory. Comparing the smoothed (Figure \@ref(fig:paleoV)) to the non-smoothed velocity (Figure \@ref(fig:paleoVelocity)) yields similar inference regarding the location of the regime shifts at 2,200 and 1,300 years before present, however, it  more clearly demonstrates potential inter-regime dynamics (e.g., between 7,000 and 4,800 years before present), that were not identified in previous study of this system [@spanbauer_prolonged_2014].
```{r paleoV,  eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE, message=FALSE, out.width="75%", fig.cap="The velocity metric  ($V$) signals potential periodicities in the paleo diatom time series data when the distance traveled metric, $s$, is smoothed using regularized differentiation methods [@price2019tvdiff]."}
# Plot derivative
# p=ggplot(paleoEx %>% 
#          filter(key == "dsdt"), 
#        aes(x = t*-1, y = value)) +
#   geom_point() +
#   labs(x = "time", 
#        y = expression(italic("v")))+
#   scale_x_reverse()

# ggsave(p, filename=paste0(figDir,"paleoV.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoV.png"))
```

## Discussion
Here, I described the steps for calculating a novel regime detection metric, system velocity ($V$). First described in @fath_regime_2003, $V$ is used as a single step for calculating a more complicated regime detection metric, Fisher Information (see also Chapter \@ref(fiGuide)). System velocity is arguably simple to calculate, as shown in this chapter, captures the total change in system variables under a variety of mean and variance conditions. The metric does not, however, perform well as variance increases (Figure \@ref(fig:simVarPlot2)), and smoothing the original data does not reduce the noise surrounding this metric when variance is moderate. Variance is a commonly-used indicator of ecological regime shifts (@brock_variance_2006), however, is difficult to interpret when the number of variables is much greater than a few. System velocity, $V$, may be useful in situations where the number of state variables is much greater than few, and appears especially useful when the magnitude of change in one or more state variables is high (Figures \@ref(fig:simVplot2),\@ref(fig:muBoth75)). For example, this method will likely identify signals of regime shifts where the shift is defined as high species turnover within a community (Figure \@ref(fig:muVarBoth1)). 

This study provides baseline expectations of the velocity of the distance traveled, $V$, as an indicator of abrupt change in a multivariate system. Although a useful first step, this metric should next be critiqued in a sensitivity analytical approach, where a statistical measure is used to determine whether $V$ indicates abrupt shifts prior to occurrence (c.f. during or after),  particularly with respect to its performance in community-level empirical data. The paleolithic diatom data used in the last section of this chapter is also presented in the documentation for my R Package,  **regimeDetectionMeasures** (Appendix \@ref(appPaleo)). In this case study, the 'distance traveled', $s$ [Equation \@ref(eq:diffX)], clearly exhibits shifts at points where expert opinion and species turnover (in species dominance) agree that a large change occurred. Further, velocity, $V$ (see *dsdt* in package materials) indicates a large shift at only the most predominant shift in the time series, perhaps due to the sensitivity of the metric to variance (Figure \@ref(fig:simVplot2). 

Further work is required to determine the utility of system velocity as a regime detection metric, however, this chapter demonstrates that the metric may indicate clear shifts in variable means and variability about the means. In addition to examining high-dimensional and noisy data, a study of the performance of $V$ under conditions where few variables exhibit large changes while many variables are relatively constant may also prove useful. Additionally, this metric may be a useful tool for reducing the dimensionality of high dimensional data. Although the metric loses much information, as opposed to some dimension reduction techniques, e.g. Principal Components Analysis PCA, the metric is simple to calculate (even by hand), is computationally inexpensive, and is intuitive, unlike many clustering algorithms (e.g., Non-metric Multidimensional Scaling NMDS). Like system velocity, methods of the latter variety (e.g. NMDS) require post-hoc statistical analyses to confirm the location of clusters (or abrupt change, regime shifts), while methods of the former variety (e.g. PCA) retain loadings but do not necessarily identify the locations of abrupt shifts. 

## Supplementary Figures
Figures \@ref(fig:velocSysEx2), \@ref(fig:velocSysEx3), and \@ref(fig:velocSysEx4) provide additional examples of the behavior of velocity, $V$ when varying the mean and/or variance prior to and/or after the induced abrupt shift in the toy system with a discontinuous transition at $t=50$.

```{r velocSysEx2,message=FALSE, warning=FALSE, echo=FALSE,   out.width="85%", fig.cap = "System change ($s$) and velocity ($V$) of the model system over the time period. Change in means ($\\bar{x}_{1_{pre}}=25$, $\\bar{x}_{1_{post}}=100$, $\\bar{x}_{2_{pre}}=50$, $\\bar{x}_{2_{post}}=10$) and an increase in variance ($\\sigma_{1_{pre}}=2$, $\\sigma_{1_{post}}=10$, $\\sigma_{2_{pre}}=5$,  $\\sigma_{2_{post}}=10$)."}
x_1 = c(rnorm(mean = 25, sd = 2, n=50), rnorm(mean =100, sd = 10, n=50))
x_2 = c(rnorm(mean = 50, sd = 5, n=50), rnorm(mean =10, sd = 10, n=50))
t = 1:length(x_1)
df  = data.frame(t, x_1, x_2) %>%
  tidyr::gather(key = "variable", value = "value", -t)
dist <- df %>%
  mutate(cellID = 1) %>%
  rename(sortVar = t) %>%
  regimeDetectionMeasures::calculate_distanceTravelled()
dsdtPlot(dist=dist, df=df, div = 1)+
  ggtitle(
  expression(paste("change in mean & variance of x"[1], "and  x"[2]))
)
```

```{r velocSysEx3, message=FALSE, warning=FALSE, echo=FALSE,   out.width="85%", fig.cap = "System change ($s$) and velocity ($V$) of the model system over the time period. Constant means ($\\bar{x}_1=25$, $\\bar{x}_2=50$) and sharp change in variance for one state variable $\\sigma_{1_{pre}} = 2$, $\\sigma_{1_{post}} = 12$, $\\sigma_{2_{pre,post}} = 5$"}
x_1 = c(rnorm(mean = 25, sd = 2, n=50), rnorm(mean =25, sd = 12, n=50))
x_2 = c(rnorm(mean = 50, sd = 5, n=50), rnorm(mean =50, sd = 5, n=50))
t = 1:length(x_1)
df  = data.frame(t, x_1, x_2) %>%
  tidyr::gather(key = "variable", value = "value", -t)
dist <- df %>%
  mutate(cellID = 1) %>%
  rename(sortVar = t) %>%
  regimeDetectionMeasures::calculate_distanceTravelled()
dsdtPlot(dist=dist, df=df, div = 1)+
  ggtitle(
  expression(paste("constant means, increased variance of x"[1]))
)
```

```{r velocSysEx4, message=FALSE, warning=FALSE, echo=FALSE,   out.width="85%", fig.cap = "System change ($s$) and velocity ($V$) of the model system over the time period. Variance equal to mean ($/bar{x_i}=/sigma_i$), where means ($/bar{x}_{1_{pre}}=25$, $/bar{x}_{1_{post}}=50$, $/bar{x}_{2_{pre}}=15$, $/bar{x}_{2_{post}}=150$)."}
x_1 = c(rnorm(mean = 25, sd = 25, n=50), rnorm(mean =50, sd = 50, n=50))
x_2 = c(rnorm(mean = 15, sd = 15, n=50), rnorm(mean =150, sd = 150, n=50))
t = 1:length(x_1)
df  = data.frame(t, x_1, x_2) %>%
  tidyr::gather(key = "variable", value = "value", -t)
dist <- df %>%
  mutate(cellID = 1) %>%
  rename(sortVar = t) %>%
  regimeDetectionMeasures::calculate_distanceTravelled()
dsdtPlot(dist=dist, df=df, div = 1)+
  ggtitle(
  expression(paste("changing means, variance = mean"))
)
```
