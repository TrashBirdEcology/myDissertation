# Velocity (*v*): using rate-of-change of  system  trajectory to identify abrupt changes {#velocity}
```{r setupChVelocity, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
# # Chunk defaults
set.seed(123)
knitr::opts_chunk$set(cache = TRUE, cache.path = "_cache/",cache.lazy = FALSE,  message = FALSE, warning=FALSE, eval=TRUE, echo=FALSE, error=FALSE, fig.align='center',out.width = "65%")

library(gridExtra)
library(magrittr)
library(tidyverse)

## source code for theme_Publications
source(here::here("chapterFiles/velocity/06-chap-velocity_helperFuns.R"))
```

```{r, cache = TRUE, echo=FALSE, warning=FALSE, eval=FALSE, message=FALSE}
# Source some helper funs
source("./chapterFiles/velocity/06-chap-velocity_helperFuns.R")

## Define a plotting function for plotting simulated and dist results
sPlot <- function(df, dist, div = 10){
  if("sortVar" %in% names(dist))dist <- dist %>% rename(t = sortVar)
  ggplot()+
  geom_line(data = df, aes(t, value, linetype=variable), color='black')+
  geom_line(data = dist, aes(x = t, y = s/div), color = "red", size =1)+
  scale_y_continuous(sec.axis = sec_axis(~.*div, name = "s"))+
    theme_bw()+
  theme(legend.position = "bottom")}

dsdtPlot <- function(df, dist, div = 10){
  if("sortVar" %in% names(dist))dist <- dist %>% rename(t = sortVar)
ggplot()+
  geom_line(data = df, aes(t, value, linetype=variable), color='black')+
  geom_line(data = dist, aes(x = t, y = dsdt/div), color = "red", size =1)+
  scale_y_continuous(sec.axis = sec_axis(~.*div, name = "v"))+ 
  theme_bw()+
  theme(legend.position = "bottom")}
```
## Introduction
When, how and why ecological systems exhibit abrupt changes is a hallmark of modern ecological research, and changes which are unexpected and undesirable can have undesirable downstream consequences on, e.g., ecosytem services, biodiversity, and human well-being. Quantitatively detecting and forecasting these changes, however, has yet to be accomplished for most ecological systems [Chapter \@ref(rdmReview); @ratajczak2018abrupt]. Moving from abrupt change methods requiring highly descriptive models and *a priori* assumptions of the state variable responses to drivers to methods requiring few, if any, *a priori* assumptions or knowledge is increasingly necessary for forecasting and managing complex ecosystems under an era of intensifying anthropogenic pressures.

A few broad classes of quantitative approaches exist for quantitatively identifying abrupt changes in complex ecosystems. First, one can use simple mathematical models to describe the system and statistically test for discontinuities in the observed variables [e.g., in coral reefs, @mumby2013evidence]. Although mathematical representations are ideal, very rarely are  ecological systems easily and well-described by them and often fail to meet the assumptions of the model. Second, we can track changes in the mean or variance of state variables to identify departures from the norm [e.g., early-warning indicators such as variance and variance index, @brock_variance_2006]. Much like the mathematical modelling approach, these early-warning indicators have shown to be useful in some simple driver-response systems [e.g., lake eutrophication @carpenter_leading_2008], but are unreliable in other empirical systems [e.g., @perretti2012regime;@dutta2018robustness;@dakos2012robustness]. The last type of approach is the model-free approach [@dakos_methods_2012; Ch. \@ref(rdmReview)]. This group of abrupt change indicators can incorporate multiple state variables, and ideally requires no *a priori* assumptions about the expected driver-response relationships, or even about the drivers at all. It is this class of abrupt change indicators to which this chapter contributes. 

### Tracking ecosystem trajectory through time to explore system dynamics
```{r lorenz3D, eval=TRUE, out.width="55%", fig.cap="An example solution of the Lorenz ('butterfly') represented in 3-dimensional phase-space. Phase plots are typically used to visualize stable areas within a system's trajectory but reconstruction requires the difference models to be known and parameterized."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/lorenz3D.png"))
```
```{r lorenz3Dts, eval=TRUE, out.width="55%", fig.cap="An example solution of the Lorenz ('butterfly') represented in individual system compoents."}
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/lorenz3D_timeseries.png"))
```

A classic example of state-switching by a system is demonstrated in the Lorenz ('butterfly') attractor [Fig. \@ref(fig:lorenz3D); @takens1981detecting]. This phase plot (Fig. \@ref(fig:lorenz3D)) provides an informative visual of the behavior of a chaotic system manifesting two attractors. Although the periodic, attractor behaviors are made clear when examining the time series of each dimension (Fig \@ref(fig:lorenz3Dts)), identifying such behaviors in additional dimensions becomes increasingly difficult. 

System behavior/trajectory in phase space are used often in dynamical systems theory and systems ecology to make inference regarding system behavior and dynamics, but phase space (trajectory) dynamics are not commonly applied outside theoretical studies as a tool for ecological data analysis [c.f. @sugihara2012detecting for an example of phase-space reconstruction using Taken's theorem of ecological time series]. Some methods of attractor reconstruction have been applied to environmental data [e.g., individual time series of fisheries stocks, climate, stock market; @sugihara2012detecting; @ye2015equation], yet they **do not incorporate the dynamics of whole-systems**. Model-free methods for exploring and describing the dynamics of whole (i.e. $>1$ variable) ecological systems are restricted to the commonly-applied dimnesion reduction techniques and clustering algorithms (e.g., Principal Components Analysis, K-means clustering). In fact, this is true of many abrupt change and regime shift indicators. 

### Rate of change as an indicator of abrupt change in the system trajectory
How quickly a system switches states [e.g., moving from attractor to another; \@ref(fig:lorenz3D)] may yield insights into the responses of ecological systems to perturbations (e.g., anthropogenically induced pressures such as climate change, urbanization) and community shifts (e.g., species introductions or extinctions, shifts in dominance). For example, @beck_variance_2018 tracked rate of change using chord distances---a data transformation for positive values and which is suitable prior to ordination analysis---to capture abrupt changes in community composition of a temperate, paleodiatom community. Chord distance, however, is greatest when the observations among data rows (e.g., time, location) have no species in common. In other words, this measurement may be most useful in high community turnover conditions. Identifying alternative numerical methods for estimating system rates of change may be when the system does not exhibit, for example, high degrees of turnover. 

Rate of change (ROC, often represented as $\Delta$) is a term used for various measures which describe the relationship among to variables, measuring the change in one variable relative to another. As a refresher ROC is represented as **speed** ($\textbf{S}$) or **velocity** ($\textbf{V}$), where ($\textbf{S}$) is the adirectional magnitude (i.e. it is a scalar) of the displacement of an object over unit time and $\textbf{V}$ describes both the direction and magnitude (i.e. it is a vector) of the object's movement in spacetime. $\textbf{S}$ is a scalar taking values of $\geq0$ and $\textbf{V}$ can take any value between $-\infty$ and $\infty$. For example, consider a car travelling at a constant speed of $50\frac{km}{h}$ around along a hilly landscape, where it is ascending and descending hills. Although $\textbf{S}$ is constant, $\textbf{V}$ changes in a sunusoidal fashion, where $\textbf{V}$ is $\textbf{V}>0$ when ascending, $\textbf{V}<0$ when descending, and $\textbf{V}\approx0$ at in the valleys and at the peaks of the hills. Although $\textbf{S}$ is useful when estimating other scalar quantities (e.g., $\frac{miles}{gallon}$), given a starting and/or final position in space, $\textbf{S}$ is not informative of its the path travelled. 

### Aims
Here, I propose a method which simply describes the rate of change behavior of system dynamics in phase space: **velocity**, $V$. An alternative to other complicated, model-free approaches [e.g., Fisher Information; @cabezas_towards_2002], the velocity metric allows one to examine the behavior of an entire system along its trajectory 
(through space or time) without having to reconstruct the pahse space. The ability to handle noisy and high-dimensional data and the lack of subjective parameters in calculating the metric makes this method an ideal alternative to existing early warning indicators and phase-space reconstruction methods. 

I first describe the steps for calculating this new metric ($v$), as both a dimension reduction technique and abrupt change indicator. Although this is the first instance of this calculation to, alone, be suggested as a regime detection metric, it has been used as part of a larger series of calculations of the Fisher Information metric [see Ch. \@ref(fiGuide)], first introduced in @fath_regime_2003. I use this theoretical system to present baseline estimates of the expected  behavior of $v$ under various scenarios of changing mean and variability in a theoretical, discussing the contexts under which this metric may signal abrupt changes. Finally, I explore the utility of this metric in identifying known regime shifts in an empirical paleoecological time series data.

### Analytical approach 
I first describe the steps for calculating velocity by constructing a simple, two-variable system which exhibits only a rapid, discontinuous change in the means of the state variables. I next vary the mean and variance of the state variables of this system to demonstrate baseline expectations for the behavior of velocity under a simple rapid shift scenario. 

Next, I construct a second model system similar to the first, but one which exhibits a non-discontinuous rapid change in the state variables. The purpose of this section is three-fold. First, I demonstrate how velocity behaves when the system undergoes varying degrees of change (e.g., slow change versus nearly discontinuous, rapid). Second, I concurrently identify baseline expectations of velocity under varying conditions of mean and variability of the state varilbes before and after a shift. Third, by introducing a smoothing function to the rapid shift, we gain an understanding of how process variability (noise) impacts the shift detectability by the velocity metric.

Finally, I calculate the velocity of an empirical, paleolitic freshwater diatom community time series to demonstrate the utility of the velocity metric in highly noisy, high dimensional, and irregularly-sampled data. 

## Calculating velocity, $v$ using a simple toy system 
In this section, I first demonstrate the calculations of velocity using a very simple, two-variable toy system. The first system exhibits a rapid shift at a single point in time, where mean and variance are constant before and after the shift point. I demonstrate the signals achieved with and the variability within the $v$ calculation by exploring a number of scenarios of this simple system. For the examples in this section, observations of $x_i$ are randomly drawn from distribution $x_i\sim Normal(\mu, \sigma)$, where $\mu$ is the mean and $\sigma$ is the standard deviation. 
```{r sysEx,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap="The 2-variable discrete time toy system used to demonstrate steps for calculating system velocity. Each variable, $x$, is drawn from a normal distribution with means that change at $t = 50$. State variables have constant standard deviation, $\\sigma = 5$."}
x_1 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
x_2 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
t = 1:length(x_1)
df.wide = data.frame(t, x_1, x_2) 
df  = data.frame(t, x_1, x_2) %>% 
  tidyr::gather(key = "variable", value = "value", -t) 

dist <- regimeDetectionMeasures::calculate_distanceTravelled(df %>% mutate(cellID = 1) %>% rename(sortVar = t)) %>% rename(t = sortVar) %>% 
  dplyr::select(-cellID)

# join results with the orig data
df.wide <- left_join(df.wide, dist) %>% 
  # add column for change in variable
  mutate(dx_1 = x_1-lag(x_1),
           dx_2 = x_2-lag(x_2), 
         dt = t - lag(t)) %>%
  dplyr::select(t, x_1, x_2, dx_1, dx_2, dt, everything(), -d2sdt2)
 
# change names of df.wide for table in latex
colnames(df.wide) <- c("t", 
                       "$x_1$",
                       "$x_2$", 
                       "$\\Delta x_1$",
                        "$\\Delta x_2$",
                        "$\\Delta t$",
                        "$\\sqrt(\\sum_{i=1}^N \\Delta x_i^2) $",
                        "$s$",
                        "$v$")
                       # "$s = \\sum_{t=1}^j(\\sqrt(\\sum_{i=1}^N(\\Delta x_i^2))) $",
                       # "$ velocity = \\frac{\\Delta s_{j,j+1}}{\\Delta t}$")
(p.sysEx <- ggplot()+
  geom_line(data = df, aes(t, value, linetype=variable), color='black')+
  theme(legend.position='bottom')+
  theme_bw())
```
Consider a system (Fig. \@ref(fig:sysEx)) with $N$ state variables ($x_i$), with observations taken at time points, $t$. System velocity is calculated as the cumulative sum over time period $t_0$ to $t_j$,  as the total change in all state variables, {$x_1 ...x_N$}, between two adjacent time points, e.g., $t_j$ and $t_{j+1}$, denoted $t_{j,j+1}$. I use this simple, two-variable system to demonstrate how *velocity* is calculated. The system comprises variables $x_1$ and $x_2$, with observations occurring at each time point $t = {1,2,3,...100}$. First, we calculate the change in each state variable, $x_i$, between two adjacent points in time, $t_j$ and $t_{j+1}$, such that the difference, $x_{t_{j+1}} - x_{t_j}$ is assigned to the latter time point, $t_{j+1}$. For example, in our toy data, we use observations at time points $t = 1$ & $t=2$ (Fig. \@ref(fig:sysEx2)). For all examples in this chapter, the state variables $x_1$ and $x_2$ were drawn from a normal distribution (using function *rnorm*), with parameters $\bar{x}_i$ (mean) and $\sigma_i$ (sd) for 100 time steps, $t$. The regime shift in this system occurs at $t=50$, where a shift in either or both $\bar{x}_i$ or $\sigma_i$.
```{r sysEx2,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap="Data used to calculate velocity at the first two time points, $t_1$ and $t_2$."}
p.sysEx +
  geom_point(data =df, aes(x = t, y = value, shape = variable, color=variable), size=4)+
  xlim(c(1,2))+#+ylim(c(20,30))+
  scale_color_manual(values=c("red","black"))+
  theme(legend.position = 'bottom')+
  theme_bw()
```
### Steps for calculating $v$
#### Step 1: Calculate $\Delta x_i$
The first step is to calculate the change in values for each state variables, $x_i$, between two consecutive time points [e.g., from time $t$ to $t+1$ for the discrete-time system; Fig. \@ref(fig:sysEx2); Eq. \@ref(eq:diffX)]:
\begin{equation}
\Delta x_i = x_{i(t+1)} - x_{it} 
(\#eq:diffX)
\end{equation}

Note that $\Delta x_i$ can take any value between $-\infty$ and $\infty$. 

#### Step 2: Calculate distance travelled, $s$
Next, we calculate the total change in the system between two points in time as $\Delta s$. This is achieved by taking this square root of the sum of squares of the changes in all state variables per Pythagora's theorem (Eq. \@ref(eq:ds)): 
\begin{equation}
\Delta s = \sqrt{\sum{\Delta x_i^2}}
(\#eq:ds)
\end{equation}

Although $\Delta s$ represents the absolute change in the system between consecutive points in time, the measure is not yet relative to the trajectory. Finally, because we are interested in identifying relative changes along the system trajectory, we calculate the distance travelled, $s$, as the cumulative sum of $\Delta s$  (Eq. \@ref(eq:ds)) over some time interval, $(0,T)$ (Eq. \@ref(eq:s)):

\begin{equation}
s_T = \Sigma_{t=0}^{T}{\Delta s}) 
  (\#eq:s)
\end{equation}

We now have a single measure, $s$ (Eq. \@ref(eq:s)), for each pair of time points in our $N$-dimensional system (Fig. \@ref(fig:sysExs)). It should be noted that $s$  (Fig. \@ref(fig:sysExs)) is monotonically increasing since the value of $\Delta s$ (Eq. \@ref(eq:ds)) is a sum of squares. Although discussed in a later section, it is important to note that $s$ is not unitless---that is, $s$ has units of the state variables, $x_i$. 
```{r sysExs, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "Distance travelled, $s$, for the 2-species toy system."}
temp <- df %>%
  group_by(variable) %>% 
  arrange(t) %>% 
  mutate(dx2 = ((value)-lag(value))^2) %>% 
  ungroup() %>% 
  group_by(t) %>% 
  mutate(ds = sqrt(sum(dx2))) %>% 
  distinct(t, ds) %>% 
  ungroup() %>%
  arrange(t)
temp[1,"ds"]=0
temp <- temp %>% 
  mutate(s = cumsum(ds))

ggplot(temp, aes(x=t, y=s))+
  geom_line()+
  theme_Publication()+
  geom_line(aes(x=50), color="grey40", linetype=2)+
  xlab("t")
```

#### Step 3: Calculate velocity, $v$ (or $\frac{\Delta s}{\Delta t}$) 
Finally, we calculate the **system velocity**, $v$ (or $\frac{\Delta s}{\Delta t}$), by first calculating the change in $s$ (Eq. \@ref(eq:s)), and then divide  by the total time elapsed between consecutive sampling points:
\begin{equation}
 v = \frac {s_{t+1}-s_{t}}{\Delta t} 
(\#eq:velocity)
\end{equation}

```{r velocSysEx1, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "System change ($s$) and velocity ($v$) of the model system over the time period. Constant means ($\\bar{x}_{pre}=25$, $\\bar{x}_{post}=10$) and sharp change in variance for both state variables, $\\sigma =5$."}
# x_1 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
# x_2 = c(rnorm(mean =25, sd = 5, n=50), rnorm(mean =100, sd = 5, n=50))
# t = 1:length(x_1)
# df.wide = data.frame(t, x_1, x_2) 
# df  = data.frame(t, x_1, x_2) %>% 
#   tidyr::gather(key = "variable", value = "value", -t) 
# 
# dist <- df %>% 
#   mutate(cellID = 1) %>% 
#   rename(sortVar = t) %>% 
#   regimeDetectionMeasures::calculate_distanceTravelled()
# 
# p<- dsdtPlot(dist=dist, df=df, div = 1)+
#   ggtitle(
#   expression(paste("changing means, constant variance"))
# )

# ggsave(p, filename=paste0(figDir,"velocitySysEx1.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/velocitySysEx1.png"))
```

```{r distTab, eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE,  message=FALSE}
library(kableExtra)
options(knitr.kable.NA = "")
kable(df.wide[1:5,],digits=3, "latex", align="c", booktabs=TRUE, escape = FALSE, 
            caption = 'Steps outlined for calculating system velocity, $v$, using the 2-variable toy data as an example.')
```

The numerical results for each step in the calculation of velocity [Eq. \@ref(eq:velocity)] is demonstrated using the first five time points of our toy system (Fig. \@ref(fig:sysEx)) in Table \@ref(tab:distTab). 

### Velocity *v* performance under varying mean and variance
I simulated 10,000 random draws of the toy system, which experiences a rapid shift at $t = 50$, while varying two each of the following system paramters at the regime shift:
 $\bar{x}_1$, increased the mean value of $x_1$ 
 $\sigma_1$, change in variance of $x_1$ 
Simulations consisted of 10,000 random samples drawn from the normal distribution for each paramter, I randomly drew the toy system samples 10,000 times under increasing values of $\bar{x}_1$ and $\sigma_1$. To identify patterns in the influence of paramter values on velocity, I present the mean values of $v$ across all simulations, with confidence intervals of $\pm 2$ standard deviations. As mentione above, the state variables $x_1$ and $x_2$ were drawn from a normal distribution (using function *rnorm*), with parameters $\bar{x}_i$ (mean) and $\sigma_i$ (sd) for 50 time steps, $t$.
```{r simV, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
# The following sections require a simulated dataset to be presnt in the results file. If it does not exist, this code chunk will run the (expensive!) simulations in the source code!
# files <- list.files("./chapterFiles/velocity/simResults", pattern= "mean_x1")
# if(!exists("quickRun")) quickRun <- NULL
# if(exists("files")& !is.null(files)) quickRun=FALSE
# if(!exists("quickRun")) quickRun=TRUE
# if(quickRun) files <- files[1:500] # when knitting thesis for minor edits...
# if(length(files) == 0){
#   mean.analy = TRUE
#   source("./chapterFiles/velocity/06-chap-velocity_exampleAnalysis.R")
# }
# 
# # Save this for knitting entire diss (takes a while.)
# if(quickRun){
# dist.sim <- do.call("rbind", lapply(paste0("./chapterFiles/velocity/simResults/",files),
# 		feather::read_feather))
# dist.sim <- saveRDS(dist.sim, "./chapterFiles/velocity/simResults/distSim_meanx1.RDS")
# }
# dist.sim <- readRDS( "./chapterFiles/velocity/simResults/distSim_meanx1.RDS")
```
#### Varying post-shift mean
I examined the influence of the magnitude of change in $x_1$ in the period before (pre; $t <50$) and after (post; $t \geq 50$) by varying the mean parameter, $\bar{x}_1$ in the set $W=\{25,30,35,...100 \}$ (Figs. \@ref(fig:simVplot1),\@ref(simVplot2)). As expected, the magnitude of $v$ increased linearly as the total difference between $\bar{x}_{1_{pre}}$ and $\bar{x}_{1_{post}}$ increased (\@ref(fig:simVplot2)). This is not surprising, as $s$ increases as the total change in abundance across the entire sytem increases  (Eq. \@ref(eq:s)), therefore, the potential maximum of $v$ also increases. This may indicate that $v$, while capable of identifying large shifts in data structure, may not pick up subtle changes (i.e. lower effect sizes).
```{r simVplot1, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "Velocity ($v$) generally increases as the total change in the mean value of $\\bar{x}_{1_{t=50}}$ increases in a single iteration of our toy system ($N_{iter}=1$, seed = 123). This 2-variable system exhibits a regime shift at $t=50$, where variance is constant $\\sigma = 5$, $\\bar{x}_1 = 25$ when $t<50$,  $\\bar{x}_2=50$ when $t\\geq50$, $\\bar{x}_1 = 25$ when $t <50$."}
# p<- ggplot(data = dist.sim %>% filter(sim.num==1, t==51), 
#        aes(x = as.integer(mean.sim), y = dsdt))+
#   geom_line()+
#   theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste("total change in ", bar("x")[1], " at ", italic("t = 50"))))
# ggsave(p, filename=paste0(figDir,"simVplot1.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVplot1.png"))
```

```{r simVplot2, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "Change in velocity ($v$) as the total change in the mean value of $\\bar{x}_{2_{t=50}}$ over 10,000 simulations. A regime shift was induced at $t=50$ with constant varoance $\\sigma = 5$, $\\bar{x}_2 = 25$ when $t<50$,  and changes in variable mean values, $\\bar{x}_2 = 50$ when $t \\geq 50$, $\\bar{x}_1 = 25$ when $t<50$."}
# dist.sim.reduced <- dist.sim %>% filter(t==51) %>% 
#          group_by(mean.sim) %>% 
#          mutate(dsdt.sim.mean  = mean(dsdt), 
#                 sd.sim    = sd(dsdt), 
#                 lower     = dsdt.sim.mean - 1.96*sd.sim, 
#                 upper     = dsdt.sim.mean + 1.96*sd.sim
#                 ) %>% 
#          distinct(mean.sim, sd.sim, lower, upper, dsdt.sim.mean) %>% 
#   ungroup() %>% 
#   mutate(mean.sim = as.integer(mean.sim))
# 
# p<- ggplot(data = dist.sim.reduced)+
#  geom_ribbon(aes(x = mean.sim, ymin = lower , ymax = upper), fill = "grey70") +
#     geom_line(aes(x = mean.sim,  y = dsdt.sim.mean))+
#     theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste("total change in ", bar("x")[1], " between ", italic("t = 50"), " and ", italic("t = 51"))))+
#   ggtitle(expression(paste("Mean ",  italic("v")," (±2SD) over ", 10,000, " iterations")))
# ggsave(p, filename=paste0(figDir,"simVplot2.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVplot2.png"))
```
```{r simVar,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
# files <- list.files("./chapterFiles/velocity/simResults", pattern= "var_x1")
# if(!exists("quickRun")) quickRun <- NULL
# if(exists("files")& !is.null(files)) quickRun=FALSE
# if(quickRun) files <- files[1:500] # when knitting thesis for minor edits...
# 
# if(length(files) ==0){
#   var.analy = TRUE
#   source("./chapterFiles/velocity/06-chap-velocity_exampleAnalysis.R")
# }
# if(quickRun){
# dist.sim <- do.call("rbind", lapply(paste0("./chapterFiles/velocity/simResults/",files),
# 		feather::read_feather))
# dist.sim <- saveRDS(dist.sim, "./chapterFiles/velocity/simResults/distSim_varx1.RDS")
# }

# dist.sim2 <- readRDS( "./chapterFiles/velocity/simResults/distSim_varx1.RDS")
# dist.sim.reduced2 <- dist.sim2 %>% filter(t==51) %>% 
#          group_by(var.sim) %>% 
#          mutate(dsdt.sim.mean  = mean(dsdt), 
#                 sd.sim    = sd(dsdt), 
#                 lower     = dsdt.sim.mean - 1.96*sd.sim, 
#                 upper     = dsdt.sim.mean + 1.96*sd.sim
#                 ) %>% 
#          distinct(var.sim, sd.sim, lower, upper, dsdt.sim.mean) %>% 
#   ungroup() %>% 
#   mutate(var.sim = as.integer(var.sim))
```

#### Varying post-shift variance
In the previous example, variance was constant before and after the shift at $t=50$. To determine whether the signal emitted by $v$ at the regime shift is lost with increasing variance, I varied the variance parameter, $\sigma_1$ in the set $W = \{1,2,3,...25 \}$. The variance for both state variables prior to the regime shift, $\sigma_1$ and $\sigma_2$, was 5, with the change occurring in $\sigma_1{_{post}}$. Sytem velocity $v$ appears senstive to increases in the variance at the point of the regime shift (Figs. \@ref(fig:simVarplot), \@ref(fig:simVarplot2)). This extreme sensitivity of $v$ to $\sigma{_{post}}$  (Fig. \@ref(fig:simVarplot2)) is unsurprising, given the fact that, without smoothing the derivatives, the tangential speed of a 'noisy' variable will always be noisy itself (see Figs. \@ref(velocitySysEx1), \@ref(velocitySysEx2), \@ref(velocitySysEx3), \@ref(velocitySysEx4)). 
```{r simVarPlot, echo=FALSE,  eval=TRUE, fig.cap = "High variance of velocity ($v$) in a single iteration ($N_{iter}=1$, seed = 123) of simulations as we increase $\\sigma_1$ at $t=50$."}
# p<- ggplot(data = dist.sim2 %>% filter(sim.num==1, t==51), 
#        aes(x = as.integer(var.sim), y = dsdt))+
#   geom_line()+
#   theme_bw()+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste(
#     # italic("W"), 
#     "total change in ", "sigma"[1], " at ", italic("t = 50"))))
# ggsave(p, filename=paste0(figDir,"simVarPlot.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVarPlot.png"))
```
```{r simVarPlot2,  cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "Average ($\\pm 2$ SD) velocity ($v$) worsens as the variance of $\\bar{x}_{2_{t=50 (post)}}$ (post shift) increases. $\\bar{x}_{1_{pre}} = 25$, $\\bar{x}_{1_{post}} = 100$, $\\bar{x}_{2_{pre}} = 25$, $\\bar{x}_{2_{post}} = 50$, $\\sigma_{1_{pre}} = 5$, $\\sigma_{2_{pre,post}} = 5$"}
# p<- ggplot(data = dist.sim.reduced2)+
#  geom_ribbon(aes(x = var.sim, ymin = lower , ymax = upper), fill = "grey70") +
#     geom_line(aes(x = var.sim,  y = dsdt.sim.mean))+
#     theme_bw()+
#   xlim(c(1,25))+
#   ylab(expression(paste("velocity, ",italic("v"), " at ", italic("t = 51"))))+
#   xlab(expression(paste(sigma, " ", bar("x")[1], " at ", italic("t = 50"))))+
#   ggtitle(expression(paste("Mean ",  italic("v")," (±2SD) over ", 10,000, " iterations")))
# 
# ggsave(p, filename=paste0(figDir,"simVarPlot2.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/simVarPlot2.png"))
```

#### Smoothing the data prior to calculating *v*
To ameliorate the influence of noise (e.g. Fig. \@ref(simVarPlot)) on the regime shift signal in $v$, I used linear approximation techniques in attempt to smooth the velocity (derivatives). I used the function *stats::approx* to interpolate values of $x_1$ and $x_2$ to regularly-spaced time points in the set $t=\{1:100\}$, and then calculated $v$ as described in the steps above (Eqs. \@ref(eq:diffX):\@ref(eq:velocity)). Increasing the number of points ($t$) at which the original state variables were smoothed did not influence the amount of noise surrounding the signal of the regime shift (at $t=50$) in system velocity, $v$ (Fig. \@ref(fig:smoothV)).

```{r smoothV, eval=FALSE, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE, fig.cap = "The noise in system velocity ($v$) is not obviously reduced in this system as the original data ($x_1$, $x_2$) is increasingly smoothed."}
# smoothed <- approx_dist.sim(t.mult = 1)
# p1<- dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("no smoothing")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 2)
# p2<- dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 2X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 5)
# p3<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 5X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 10)
# p4<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 10X")+theme(legend.position="none")
# smoothed <- approx_dist.sim(t.mult = 100)
# p5<-dsdtPlot(df = smoothed[[1]],dist = smoothed[[2]], div = 1/1.4)+
#   ggtitle("increase t by 100X")
# p<- cowplot::plot_grid(p1,p2,p3,p4,p5)
# ggsave(p, filename=paste0(figDir,"smoothV.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/smoothV.png"))
```
## Velocity performance in a toy system with smooth transitions 
Although the data constructed in this section are similar to that used in the previous section in that we are manipulating the mean and variance of two state variables before and/or after an abrupt shift, this section introduces a component of process noise into the shift itself. This is important because the derivative of a nearly discontinuous function is infinite. Although we are interested in identifying this type of rapid change, velocity will appraoch infinity regardless of the effect size. In other words, if the system exhibits turnover in e.g. $25\%$ of the state variables, the value of velocity will be equal to that of turnover in e.g. $75\%$ of the variables. Removing the possibility of infinite values provides more relative measures within the community time series. 

### Generating the data
Here we consider a two-variable system over the time interval $[1,100]$ with state variables $x_1$ and $x_2$ which exhibits abrupt shifts in mean and/or variance of one or both variables at time $t=50$. I generated species observations for the true process and  the true process with process variability. The true process data were created using the paramters for $\mu$ and $\sigma$ for each of the conditions in described in Table \@ref(tab:sysParams) (random seed in Program R was 12345).

#### True process model
Data were generated from a normal distribution and an abrupt shift in the mean was incorporated using a hyperbolic tangent function. The true process for each state variable, $x_i$, was generated from Eq. (\@ref(eq:true)):
 x_1_obs <- x_1_true + x_1_err
  x_2_err <- c(
    rnorm(
      mean = 0,
      sd = mu_2a * sd.perc_2a,
      n = tregime
    ),
    rnorm(
      mean = 0,
      sd = mu_2b * sd.perc_2b,
      n = tregime
    )
  )
\begin{equation}
<!-- \begin{array} -->
\mu_i_{pre} \sim Normal(\mu_i_{pre},\sigma_i_{pre}) \\ 
\mu_i_{post} \sim Normal(\mu_i_{post},\sigma_i_{post}) \\ 
\sigma_i_{post} \sim Normal(0,\sigma_i_{post}\mu_i_{post}) \\ 


\mu_{x_i}(t) = \mu_{i_{pre}}  - 0.5(\mu_{i_{pre}}-\mu_{i_{post}})(\tanh(\alpha (t-t_{shift}))+1) \\
(#eq:true)
<!-- \end{array} -->
\end{equation}

where $\mu_{x_i}(t)$ is the mean value of $x_i$ at time $t$ and *pre* and *post* are the periods before and after the abrupt shift ($t_{shift}$), respectively.
The parameter $\alpha$ controls for the rate of change at the point of the abrupt change, $t_{shift}$, where higher values of $\alpha$ correspond with a higher slope at $t_{shift}$. 

I generated a single dataset for each condition (see Table \@ref(tab:sysParams)) containing the true process values for $x_1\ \&\ x_2$ at intervals of $t=1$ along the temporal interval [1,100].

#### Observed process data

$\sigma_i_{post} $\sim \\Normal(0,\sigma_i_{post}\mu_i_{post})$
$\sigma_{i_{post}} \sim Normal(0, )$


```{r sysParams, echo=FALSE, eval=TRUE, cache=TRUE}
params <- data.frame(
  sd.perc_1a = c(0.05, 0.05, 0.05, 0.05, 0.05,  0.05), # percent of the mean will determine the sd_1a ... sd_2b
  sd.perc_1b = c(0.10, 0.10, 0.05, 0.05, 0.10,  0.10),
  sd.perc_2a = c(0.05, 0.05, 0.05, 0.05, 0.05,  0.05),# percent of the mean will determine the sd_1a ... sd_2b
  sd.perc_2b = c(0.10, 0.05, 0.05, 0.05, 0.10,  0.05),
       mu_1a = c(10,     10,   10,   10,   10,  10),
       mu_1b = c(55,     55,   55,   55,   10,  10),
       mu_2a = c(15,     15,   15,   15,   15,  15),
       mu_2b = c(44,     15,   44,   15,   15,  15)
)

colnames(params) <- c(
  "$\\sigma_{x_{1_{pre}}}$",
  "$\\sigma_{x_{1_{post}}}$",
  "$\\sigma_{x_{2_{pre}}}$",
  "$\\sigma_{x_{2_{post}}}$",
  "$\\mu_{x_{1_{pre}}}$",
  "$\\mu_{x_{1_{post}}}$",
  "$\\mu_{x_{2_{pre}}}$",
  "$\\mu_{x_{2_{post}}}$"
)

conditions <-c( 
  "$\\mu_{x_1}$, $\\mu_{x_2}$, $\\sigma_{x_1}$, $\\sigma_{x_2}$", 
  "$\\mu_{x_1}$, $\\sigma_{x_1}$", 
  "$\\mu_{x_1}$, $\\mu_{x_2}$", 
  "$\\mu_{x_1}$", 
  "$\\sigma_{x_1}$, $\\sigma_{x_2}$", 
  "$\\sigma_{x_1}$" 
)   
myTab <- cbind(conditions, params)
require(kableExtra)
options(knitr.kable.NA = "")
kable(myTab,digits=2, "latex", align="l", booktabs=TRUE, escape = FALSE, 
            caption = 'Conditions for generating various scenarios of the hyperbolic tangent-induced abrupt change. $\\sigma_i$ represents the standard deviation of $\\mu_{x_i}$ as the percent of $\\mu_{x_i}$, $\\mu_{x_i}$ is the mean of the state variable, $x_i$, and pre and post represent the periods before and after the regime shift at $t=50$, respectively.')
```

<!-- ```{r plotname, echo=FALSE, warning=F, message=F, cache = T, fig.cap=""} -->
<!-- knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/.png")) -->
<!-- ``` -->


## Application to empirical data: paleolithic freshwater diatom community
```{r tvDiffPaleoCalculate, cache = TRUE, echo=FALSE, warning=FALSE, eval=TRUE, message=FALSE}
library(tvdiff)
library(tidyr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())

# Load data
data("paleo")

# Linear interpolate data 
xout <- seq(min(paleo$sortVar), max(paleo$sortVar), length.out = 700)
paleoInterp <- 
  paleo %>%
  dplyr::select(-cellID, -site) %>% 
  rename(t = sortVar, y = value) %>% 
  group_by(variable) %>% 
  nest() %>% 
  mutate(
    t = purrr::map(data, ~ approx(.$t, .$y, xout = xout)$x, rule = 1),
    y = purrr::map(data, ~ approx(.$t, .$y, xout = xout)$y, rule = 1)
  ) %>%
  dplyr::select(-data) %>%
  unnest()

# Calculate distance
paleoDistance <- 
  paleoInterp %>% 
  group_by(variable) %>% 
  mutate(dy = lead(y) - y,
         dt = lead(t) - t) %>% 
  group_by(t) %>% 
  summarize(ds = sqrt(sum(dy^2))) %>% 
  mutate(s = cumsum(ds)) %>% 
  dplyr::select(-ds) %>% 
  na.omit()

# Build dataframe
paleoEx <-
  paleoDistance %>% 
  mutate(dt = lead(t) - t) %>% 
  # Estimate derivative
  mutate(dsdt =
           TVRegDiffR(
             data = s,
             iter = 2e3,
             alph = 100,
             scale = "small",
             ep = 1e-6,
             dx = dt[1]
           )[-1]) %>% 
  # Simple numerical integration
  mutate(pred = s[1] + cumsum(dsdt*dt)) %>% 
  # Collect in long form
  gather(key, value, -t, -dt)
```
```{r paleoTurnover, echo=FALSE, warning=F, message=F, cache = T, fig.cap="Relative abundances of the most common diatom species in the time series. Few species dominate the data over the entire time series, and turnover is apparent at multiple observations."}
# topSpecies <-
#   paleo %>%
#   group_by(variable) %>%
#   summarize(q95 = quantile(value, 0.95)) %>%
#   arrange(desc(q95))
# topSpecies <- topSpecies[1:10,]
# plotData <-
#   paleo %>%
#   mutate(variable = if_else(variable %in% topSpecies$variable, variable, "Other (n = 99)")) %>%
#   mutate(variable = factor(variable, levels = c(sort(topSpecies$variable), "Other (n = 99)"))) %>%
#   group_by(sortVar, variable) %>%
#   summarize(value = sum(value)) %>% 
#   mutate(year.plot = -1*sortVar)
# 
# # Generate top species abundance plot to see turnover
# p<-
#    ggplot(data = plotData,
#           aes(x = year.plot, y = value, fill = variable)) +
#    geom_area() +
#    geom_rug(sides = "b") +
#    scale_fill_brewer(palette = "Paired") +
#      theme_bw()+
#    theme(legend.position = "top") +
#    labs(x = "years before 1950", y = "relative abundance", fill = "variable")+
#      scale_x_reverse()
# ggsave(p, filename=paste0(figDir,"paleoTurnover.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoTurnover.png"))
```

To gather baseline information on the use of velocity in empirical systems data, I calculated velocity for the paleodiatom system described in Chapter \@ref(resampling) (see also Appendix \@ref(appPaleo). Briefly, the paleodiatom community comprises `r length(unique(paleo$variable))` time series over a period of approximately `r abs(max(paleo$sortVar)-min(paleo$sortVar)) %>% round(0)` years (Fig. \@ref(fig:paleoTurnover)). As elaborated in @spanbauer_prolonged_2014, the paleodiatom community is suggested to have undergone regime shifts at multiple points. These abrupt changes are apparent when exploring the relative abundaces over time, as there are extreme levels of species turnover at multiple points in the data (Fig. \@ref(fig:paleoTurnover)). Using Fisher Information and climatological records, @spanbauer_prolonged_2014 suggest that regime shifts in this system at approximately 1,300 years before present (where present is equal to year 1950).
```{r paleoVelocity,  echo=FALSE, warning=F, message=F, cache = T,  fig.cap ="Velocity $v$ and distance travelled $s$ of the paleodiatom time series. Dashed line at 1,300 years before 1950 indicates the regime shift identifed in Spanbauer et al. (2014). Dotted lines indicate regime shifts as visually identified on metrics $s$ and $v$."}
# plotData <- regimeDetectionMeasures::calculate_distanceTravelled(paleo) %>% na.omit(d2sdt2) %>% 
#   rename(acceleration= d2sdt2, 
#          v = dsdt) %>% 
#   gather(key ="key", value="value", -cellID,-sortVar) %>% 
#   filter(!key %in% c("acceleration","ds"))
# 
# p<- ggplot(plotData, aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   facet_wrap(~key, ncol=1, scales="free_y", strip.position="left")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#      scale_x_reverse()+
#   geom_vline(xintercept = 1300, color="red",size=.8, linetype=2)+
#   geom_vline(xintercept = c(1383, 2150, 4800), color="blue",linetype=3, size=.8)
# ggsave(p, filename=paste0(figDir,"paleoVelocity.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoVelocity.png"))
```
```{r paleoRegime1and3,  echo=FALSE, warning=F, message=F, cache = T,  fig.cap ="Velocity ($v$) indicates periodic-like conditions in the first (A) and second (B) regimes."}
# p1=ggplot(plotData %>% filter(sortVar < -5000, key=="v"), aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#  annotate("text", x=6800, y=0.10, size=4.5, label= expression(bold("")))+ 
#      scale_x_reverse()
# 
# p2=ggplot(plotData%>% filter(sortVar < -1250, sortVar > -2200, key=="v"), aes(x = sortVar*-1, y = value))+
#   geom_line()+
#   ylab("")+
#   theme_bw()+
#   theme(panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         panel.border = element_rect(colour = "black"))+
#         labs(x = "years before 1950")+
#  annotate("text", x=2125, y=0.20, size=4.5, label= expression(bold("")))+ 
#      scale_x_reverse()
# p<- cowplot::plot_grid(p1, p2, ncol=1, labels="AUTO")
# 
# ggsave(p, filename=paste0(figDir,"paleoRegime1and3.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoRegime1and3.png"))
```

@spanbauer_prolonged_2014 used different regime detection metrics coupled with regional climatological events to identify regime shifts in the system, suggest that a regime shift occurred at ~1,300 years before present. Using the methods outlined above, I calculated the distance travelled ($s$) and velocity ($v$; Fig. \@ref(fig:paleoV)). The results of $v$ and $s$ (\@ref(fig:paleoVelocity)) on the relative abundance data correspond with both the large shifts in species dynamics (see Fig \@ref(fig:paleoTurnover), and also with the regime shift identified by @spanbauer_prolonged_2014. However, two primary results can be made from the metrics  $v$ and $s$ that are not obvious nor identified numerically in the results of @spanbauer_prolonged_2014 (): 
1. Two additional large shifts occurred at approximately 2,500, 4,800 and years before 1950       
1. The periods before the first and after the second large shifts appear oscillatory (Fig. \@ref(fig:paleoRegime1and3)).  
To determine whether removing the noise in the data, I interpolated the each time series using function `stats::approx` to 700 time points. Next, I calculated the distance travelled of the entire system, $s$. Finally, I obtained the derivative of $s$ by using a regularized differentiation (using function `tvdiff::TVRegDiffR`; parameters were $iter = 2000$, scale = small, $ep = 1 x 10^-6$, and $\alpha = 100$)^[\*We created the R-wrapper `tvdiff` as a Python wrapper for the tvdiff MatLab package @price2019tvdiff].. This method of regularized differentiation is an ideal approach to smoothing $s$ because it assumes the data are non-smooth and incorporates finite differencing. 
```{r paleoObsPred, eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE,  message=FALSE, fig.cap = "The regularized differentiation of $s$ was best fit using $\\alpha = 100$. Higher overlap of $s$ and pred indicates a good fit of the regularized differentiated metric to the non-smoothed metric, $s$."}
# Plot observed vs predicted
# p=ggplot(paleoEx %>% 
#          filter(key %in% c("s", "pred")), 
#        aes(x = t, y = value, color = key, linetype = key)) +
#   geom_line(size = 1.2) +
#   labs(x = "time",
#        y = "cumulative change in state (s)")
# ggsave(p, filename=paste0(figDir,"paleoObsPred.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoObsPred.png"))
```

The smoothed velocity (\@ref(fig:paleoV)) provides a similar but smoother picture of the velocity of the system trajectory. Comparing the smoothed (\@ref(fig:paleoV)) to the non-smoothed velocity (\@ref(fig:paleoVelocity)) yields similar inference regarding the location of the regime shifts at 2,200 and 1,300 years before present, however, it  more clearly demonstrates potential inter-regime dynamics (e.g., between 7,000 and 4,800 years before present), which were not identified in previous study of this ssytem [@spanbauer_prolonged_2014].
```{r paleoV,  eval=TRUE, cache = TRUE, echo=FALSE, warning=FALSE, message=FALSE,fig.cap="The velocity metric  ($v$) signals potential periodicities in the paleo diatom time series data when the distance travelled metric, $s$, is smoothed using regularized differentiation methods [@price2019tvdiff]."}
# Plot derivative
# p=ggplot(paleoEx %>% 
#          filter(key == "dsdt"), 
#        aes(x = t*-1, y = value)) +
#   geom_point() +
#   labs(x = "time", 
#        y = expression(italic("v")))+
#   scale_x_reverse()

# ggsave(p, filename=paste0(figDir,"paleoV.png"))
knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/paleoV.png"))
```

## Discussion
In this chapter, I described the steps for calculating a novel regime detection metric, system velocity ($v$). First described in @fath_regime_2003, $v$ is used as a single step for caclulating a more complicated regime detection metric, Fisher Information (see also Chapter \@ref(fiGuide)). System velocity is arguably simple to calculate, as shown in this chapter, captures the total change in system variables under a variety of mean and variance conditions. The metric does not, however, perform well as variance increases (Fig. \@ref(simVarPlot2)), and smooothing the original data does not reduce the noise surrounding this metric when variance is moderate (Fig. \@ref(smoothV)). 

Variance is a commonly-used indicator of ecological regime shifts (@brock_variance_2006), however, fails to perform when the number of variables is  >> a few. System velocity, $v$, may be useful in situations where the number of state variables is much greater than a few,  and appears especially useful when the magnitude of change in one or more state variables is high (Fig. \@ref(fig:simVplot2)). For example, this method will likely identify signals of regime shifts where the shift is defined as high species turnover within a community. 

I tested the efficacy of this metric as an indicator of abrupt change in a two-variable system. Although a useful first step, this metric should be considered in a multi-species context, and particularly in community-level empirical data which is difficult to simulate. I demonstrate a compelling case study in materials associated with my R Package, **regimeDetectionMeasures**, and in Appendix \@ref(appPaleo) in which multiple species turnover events are apparent in a paleodiatom community time series. In this case study, the 'distance travelled', $s$ (Eq. \@ref(eq:diffXsq2)), clearly exhibits shifts at points where expert opinion and species turnover (in species dominance) agree that a large change occurred. Further, velocity, $v$ (see *dsdt* in the package materials) indicates a large shift at only the most predonimnant shift in the time series, perhaps due to the metric's sensitivity to variance (Fig. \@ref(fig:simVplot2). 

Further work is required to determine the utility of system velocity as a regime detection metric, however, this chapter demonstrates that the metric may indicate clear shifts in variable means. For multispecies data you will typically need to reduce dimensionality before you can proceed with analyses, for example using some sort of ordination. In addition to examining high-dimensional and noisy data, a study of the performance of $v$ under conditions where few variables exhibit large changes while many variables are relatively constant may also prove useful. Additionally, this metric may be a useful tool for reducing the dimensionality of high dimensional data. Although the metric loses much information, as opposed to some dimension reduction techniques, e.g. Principal Components Analysis PCA, the metric is simple to calculate (even by hand), is computationally inexpensive, and is intuitive, unlike many clustering algorithms (e.g., Non-metric Multidimensional Scaling NMDS). Like system velocity, methods of the latter variety (e.g. NMDS) require post-hoc statistical analyses to confirm the location of clusters (or abrupt change, regime shifts), while methods of the former variety (e.g. PCA) retain loadings but do not necessarily identify the locations of abrupt shifts. 

<!-- ## Supplementary Figures -->
<!-- This section (Figs.  \@ref(fig:velocSysEx2), \@ref(fig:velocSysEx3), and \@ref(fig:velocSysEx4) ) contains additional examples of the behavior of velocity, $v$ when varying the mean and/or variance prior to and/or after the regime shift at $t=50$. Although the velocity signal is damped when the variance is increased (Fig. \@ref(fig:velocitySysEx3))), the magnitude of the variance of $v$ is clearly larger after than before the regime shift. -->

<!-- ```{r velocSysEx2,message=FALSE, warning=FALSE, echo=FALSE,  fig.cap = "System change ($s$) and velocity ($v$) of the model system over the time period. Change in means ($\\bar{x}_{1_{pre}}=25$, $\\bar{x}_{1_{post}}=100$, $\\bar{x}_{2_{pre}}=50$, $\\bar{x}_{2_{post}}=10$) and an increase in variance ($\\sigma_{1_{pre}}=2$, $\\sigma_{1_{post}}=10$, $\\sigma_{2_{pre}}=5$,  $\\sigma_{2_{post}}=10$)."} -->
<!-- x_1 = c(rnorm(mean = 25, sd = 2, n=50), rnorm(mean =100, sd = 10, n=50)) -->
<!-- x_2 = c(rnorm(mean = 50, sd = 5, n=50), rnorm(mean =10, sd = 10, n=50)) -->
<!-- t = 1:length(x_1) -->
<!-- df  = data.frame(t, x_1, x_2) %>%  -->
<!--   tidyr::gather(key = "variable", value = "value", -t)  -->
<!-- dist <- df %>%  -->
<!--   mutate(cellID = 1) %>%  -->
<!--   rename(sortVar = t) %>%  -->
<!--   regimeDetectionMeasures::calculate_distanceTravelled() -->
<!-- dsdtPlot(dist=dist, df=df, div = 1)+ -->
<!--   ggtitle( -->
<!--   expression(paste("change in mean & variance of x"[1], "and  x"[2])) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r velocSysEx3, message=FALSE, warning=FALSE, echo=FALSE, fig.cap = "System change ($s$) and velocity ($v$) of the model system over the time period. Constant means ($\\bar{x}_1=25$, $\\bar{x}_2=50$) and sharp change in variance for one state variable $\\sigma_{1_{pre}} = 2$, $\\sigma_{1_{post}} = 12$, $\\sigma_{2_{pre,post}} = 5$"} -->
<!-- x_1 = c(rnorm(mean = 25, sd = 2, n=50), rnorm(mean =25, sd = 12, n=50)) -->
<!-- x_2 = c(rnorm(mean = 50, sd = 5, n=50), rnorm(mean =50, sd = 5, n=50)) -->
<!-- t = 1:length(x_1) -->
<!-- df  = data.frame(t, x_1, x_2) %>%  -->
<!--   tidyr::gather(key = "variable", value = "value", -t)  -->
<!-- dist <- df %>%  -->
<!--   mutate(cellID = 1) %>%  -->
<!--   rename(sortVar = t) %>%  -->
<!--   regimeDetectionMeasures::calculate_distanceTravelled() -->
<!-- dsdtPlot(dist=dist, df=df, div = 1)+ -->
<!--   ggtitle( -->
<!--   expression(paste("constant means, increased variance of x"[1])) -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r velocSysEx4, message=FALSE, warning=FALSE, echo=FALSE, fig.cap = "System change ($s$) and velocity ($v$) of the model system over the time period. Variance equal to mean ($/bar{x_i}=/sigma_i$), where means ($/bar{x}_{1_{pre}}=25$, $/bar{x}_{1_{post}}=50$, $/bar{x}_{2_{pre}}=15$, $/bar{x}_{2_{post}}=150$)."} -->
<!-- x_1 = c(rnorm(mean = 25, sd = 25, n=50), rnorm(mean =50, sd = 50, n=50)) -->
<!-- x_2 = c(rnorm(mean = 15, sd = 15, n=50), rnorm(mean =150, sd = 150, n=50)) -->
<!-- t = 1:length(x_1) -->
<!-- df  = data.frame(t, x_1, x_2) %>%  -->
<!--   tidyr::gather(key = "variable", value = "value", -t)  -->
<!-- dist <- df %>%  -->
<!--   mutate(cellID = 1) %>%  -->
<!--   rename(sortVar = t) %>%  -->
<!--   regimeDetectionMeasures::calculate_distanceTravelled() -->
<!-- dsdtPlot(dist=dist, df=df, div = 1)+ -->
<!--   ggtitle( -->
<!--   expression(paste("changing means, variance = mean")) -->
<!-- ) -->
<!-- ``` -->


<!-- # END RUN -->

<!-- ```{r plotname, echo=FALSE, warning=F, message=F, cache = T, fig.cap=""} -->
<!-- knitr::include_graphics(here::here("chapterFiles/velocity/figsCalledInDiss/.png")) -->
<!-- ``` -->
